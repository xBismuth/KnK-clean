<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Shopping Cart - Kusina ni Katya</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          accent: '#cda45e',
          'accent-light': '#e5b66a',
          'accent-dark': '#b8924e',
          dark: '#1a1a1a',
          'dark-light': '#2d2d2d',
          'light-bg': '#fef9f3',
          'cream': '#f5e9da',
        },
        fontFamily: {
          poppins: ['Poppins', 'sans-serif'],
        },
      },
    },
  }
</script>

<style>
body { font-family: 'Poppins', sans-serif; }
.font-quiapo { font-family: 'Quiapo', 'Poppins', sans-serif; }
.smooth-scroll { scroll-behavior: smooth; }
.payment-method-option:has(input:checked) {
  border-color: #cda45e;
  background-color: #fef9f3;
}
@keyframes checkmark {
  0% { transform: scale(0); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}
.success-check { animation: checkmark 0.3s ease-out; }
.cart-item-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  background: linear-gradient(135deg, #cda45e 0%, #e5b66a 100%);
}
</style>
</head>

<body class="bg-light-bg text-dark smooth-scroll overflow-x-hidden">

<!-- HEADER -->
<header class="sticky top-0 z-50 bg-white/80 backdrop-blur shadow-md">
  <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-20">
      <div class="flex items-center space-x-3">
        <div class="w-14 h-14 bg-gradient-to-br from-accent to-accent-dark rounded-full flex items-center justify-center shadow-lg">
          <span class="text-white text-2xl font-bold">K</span>
        </div>
        <div class="hidden sm:block">
          <h1 class="font-quiapo text-2xl font-bold text-accent tracking-widest">Kusina ni Katya</h1>
          <p class="text-xs text-gray-600">Authentic Filipino Cuisine</p>
        </div>
      </div>
      <a href="index.html" class="text-accent hover:text-accent-dark font-semibold transition-colors">‚Üê Back to Home</a>
    </div>
  </nav>
</header>

<!-- MAIN CONTENT -->
<section class="py-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-7xl mx-auto">
    <div class="mb-12">
      <h1 class="text-4xl md:text-5xl font-bold text-dark mb-2">Shopping Cart</h1>
      <div class="w-24 h-1 bg-gradient-to-r from-accent-dark via-accent to-accent-light rounded-full"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Cart Items -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl p-6 shadow-lg">
          <h2 class="text-2xl font-bold text-dark mb-6">Order Summary</h2>
          <div id="cart-items" class="space-y-4"></div>
          <div id="empty-cart" class="text-center py-12 hidden">
            <p class="text-gray-500 text-lg mb-4">Your cart is empty</p>
            <a href="index.html" class="text-accent hover:text-accent-dark font-semibold">Continue Shopping ‚Üí</a>
          </div>
        </div>
      </div>

      <!-- Payment & Order Details -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
          <h3 class="text-xl font-bold text-dark mb-6">Order Details</h3>
          
          <!-- Applied Voucher Display -->
          <div id="applied-voucher-display" class="hidden mb-6 p-3 bg-gradient-to-r from-green-50 to-green-100 rounded-lg border-2 border-green-300">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-xs text-green-700 font-medium">Voucher Applied</p>
                <p id="voucher-code" class="font-bold text-green-800"></p>
              </div>
              <button onclick="removeVoucher()" class="text-red-500 hover:text-red-700 text-xs font-semibold">
                Remove
              </button>
            </div>
          </div>
          
          <div class="space-y-3 mb-6 pb-6 border-b border-gray-200">
            <div class="flex justify-between text-gray-600">
              <span>Subtotal:</span>
              <span id="subtotal">‚Ç±0.00</span>
            </div>
            <div id="voucher-discount-row" class="hidden flex justify-between text-green-600">
              <span>Voucher Discount:</span>
              <span id="voucher-discount">-‚Ç±0.00</span>
            </div>
            <div class="flex justify-between text-gray-600">
              <span>Delivery Fee:</span>
              <span id="delivery-fee">‚Ç±30.00</span>
            </div>
            <div class="flex justify-between text-gray-600">
              <span>Tax (12%):</span>
              <span id="tax">‚Ç±0.00</span>
            </div>
          </div>

          <div class="flex justify-between text-xl font-bold text-dark mb-6">
            <span>Total:</span>
            <span id="total">‚Ç±0.00</span>
          </div>

          <!-- Voucher Input Section -->
          <div class="mb-6 p-4 bg-accent/5 rounded-lg border-2 border-accent/20">
            <label class="block text-sm font-semibold text-dark mb-2">Have a Voucher?</label>
            <div class="flex gap-2">
              <input 
                type="text" 
                id="voucher-input" 
                placeholder="Enter code" 
                class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-accent text-sm uppercase"
              >
              <button onclick="applyVoucher()" class="px-4 py-2 bg-accent text-white font-semibold rounded-lg hover:bg-accent-dark transition-colors text-sm">
                Apply
              </button>
            </div>
            <a href="profile.html" class="text-xs text-accent hover:text-accent-dark font-semibold mt-2 inline-block">
              View available vouchers ‚Üí
            </a>
          </div>

          <!-- Delivery Option -->
          <div class="mb-6">
            <label class="block text-sm font-semibold text-dark mb-3">Delivery Option</label>
            <select id="delivery-option" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-accent" onchange="updateTotals()">
              <option value="delivery">Delivery (‚Ç±30)</option>
              <option value="pickup">Pickup (Free)</option>
            </select>
          </div>

          <!-- Customer Info -->
          <div class="mb-6">
            <label class="block text-sm font-semibold text-dark mb-2">Full Name</label>
            <input type="text" id="customer-name" placeholder="Full Name" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-accent">
          </div>

          <div class="mb-6">
            <label class="block text-sm font-semibold text-dark mb-2">Email</label>
            <input type="email" id="customer-email" placeholder="Email" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-accent">
          </div>

          <div class="mb-6">
            <label class="block text-sm font-semibold text-dark mb-2">Phone Number</label>
            <input type="tel" id="customer-phone" placeholder="Phone Number" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-accent">
          </div>

          <!-- Payment Method -->
          <div class="mb-6">
            <label class="block text-sm font-semibold text-dark mb-3">Payment Method</label>
            <div class="space-y-3">
              <label class="flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-accent transition-colors payment-method-option">
                <input type="radio" name="payment-method" value="card" class="mr-3 w-5 h-5 text-accent" checked onchange="togglePaymentForm()">
                <div class="flex items-center gap-3">
                  <svg class="w-8 h-8 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                  </svg>
                  <div>
                    <div class="font-medium">Credit/Debit Card</div>
                    <div class="text-xs text-gray-500">Visa, Mastercard, JCB</div>
                  </div>
                </div>
              </label>
              
              <label class="flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-accent transition-colors payment-method-option">
                <input type="radio" name="payment-method" value="gcash" class="mr-3 w-5 h-5 text-accent" onchange="togglePaymentForm()">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 bg-blue-500 rounded flex items-center justify-center text-white font-bold text-sm">G</div>
                  <div>
                    <div class="font-medium">GCash</div>
                    <div class="text-xs text-gray-500">Pay via GCash wallet</div>
                  </div>
                </div>
              </label>
            </div>
          </div>

          <!-- Card Form -->
          <div id="card-payment-form" class="mb-6 p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
            <h4 class="font-semibold text-dark mb-4">Card Details</h4>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-dark mb-2">Card Number</label>
                <input type="text" id="card-number" placeholder="4343 4343 4343 4345" maxlength="19" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-accent" oninput="formatCardNumber(this)">
                <p class="text-xs text-gray-500 mt-1">Test: 4343 4343 4343 4345 (Success) or 4571 7360 0000 0008 (Failed)</p>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-dark mb-2">Expiry Date</label>
                  <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-accent" oninput="formatExpiry(this)">
                </div>
                <div>
                  <label class="block text-sm font-medium text-dark mb-2">CVC</label>
                  <input type="text" id="card-cvc" placeholder="123" maxlength="3" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-accent" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-dark mb-2">Cardholder Name</label>
                <input type="text" id="card-name" placeholder="JUAN DELA CRUZ" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-accent uppercase">
              </div>
            </div>
          </div>

          <!-- GCash Info -->
          <div id="gcash-payment-info" class="mb-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-200 hidden">
            <div class="flex items-start gap-3">
              <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">G</div>
              <div>
                <h4 class="font-semibold text-dark mb-2">GCash Payment</h4>
                <p class="text-sm text-gray-700 mb-2">You will be redirected to GCash to complete your payment securely.</p>
                <ul class="text-xs text-gray-600 space-y-1">
                  <li>‚úì Instant payment confirmation</li>
                  <li>‚úì Secure and encrypted</li>
                  <li>‚úì No card details required</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Checkout Button -->
          <button onclick="initiateCheckout()" class="w-full px-6 py-4 bg-gradient-to-r from-accent to-accent-dark text-white font-bold text-lg rounded-full hover:shadow-xl hover:scale-105 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed" id="checkout-btn">
            <span class="flex items-center justify-center gap-2">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
              </svg>
              Proceed to Payment
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
const DELIVERY_FEE = 30;
const TAX_RATE = 0.12;
const API_URL = 'http://localhost:3000/api';
const AUTH_URL = 'http://localhost:3000/auth';
let cart = [];
let appliedVoucher = null;

function getAuthToken() {
  return sessionStorage.getItem('authToken');
}

function loadCartFromStorage() {
  const saved = localStorage.getItem('kusinaCart');
  cart = saved ? JSON.parse(saved) : [];
}

// Load and auto-apply voucher if selected from profile
function loadSelectedVoucher() {
  const selectedVoucher = localStorage.getItem('selectedVoucher');
  if (selectedVoucher) {
    appliedVoucher = JSON.parse(selectedVoucher);
    document.getElementById('voucher-input').value = appliedVoucher.id;
    localStorage.removeItem('selectedVoucher'); // Clear after loading
    displayAppliedVoucher();
    updateTotals();
  }
}

function applyVoucher() {
  const voucherCode = document.getElementById('voucher-input').value.trim().toUpperCase();
  
  if (!voucherCode) {
    alert('Please enter a voucher code');
    return;
  }
  
  // Get vouchers from localStorage
  const savedVouchers = localStorage.getItem('kusinaVouchers');
  const vouchers = savedVouchers ? JSON.parse(savedVouchers) : [];
  
  const voucher = vouchers.find(v => v.id === voucherCode);
  
  if (!voucher) {
    alert('Invalid voucher code!');
    return;
  }
  
  // Check minimum spend
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  if (subtotal < voucher.minSpend) {
    alert(`Minimum spend of ‚Ç±${voucher.minSpend} required for this voucher. Current subtotal: ‚Ç±${subtotal.toFixed(2)}`);
    return;
  }
  
  appliedVoucher = voucher;
  displayAppliedVoucher();
  updateTotals();
  alert(`Voucher ${voucherCode} applied successfully! üéâ`);
}

function displayAppliedVoucher() {
  if (appliedVoucher) {
    document.getElementById('applied-voucher-display').classList.remove('hidden');
    document.getElementById('voucher-code').textContent = appliedVoucher.id + ' - ' + appliedVoucher.discount;
    document.getElementById('voucher-discount-row').classList.remove('hidden');
  }
}

function removeVoucher() {
  appliedVoucher = null;
  document.getElementById('voucher-input').value = '';
  document.getElementById('applied-voucher-display').classList.add('hidden');
  document.getElementById('voucher-discount-row').classList.add('hidden');
  updateTotals();
  alert('Voucher removed');
}

function calculateVoucherDiscount(subtotal, deliveryFee) {
  if (!appliedVoucher) return 0;
  
  switch (appliedVoucher.type) {
    case 'percentage':
      return subtotal * (appliedVoucher.value / 100);
    case 'fixed':
      return appliedVoucher.value;
    case 'shipping':
      return deliveryFee;
    default:
      return 0;
  }
}

function displayCart() {
  const cartItemsContainer = document.getElementById('cart-items');
  const emptyCartDiv = document.getElementById('empty-cart');
  
  loadCartFromStorage();
  
  if (!cart || cart.length === 0) {
    cartItemsContainer.innerHTML = '';
    emptyCartDiv.classList.remove('hidden');
    return;
  }
  
  emptyCartDiv.classList.add('hidden');
  
  cartItemsContainer.innerHTML = cart.map((item, index) => `
    <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg border-2 border-gray-200 hover:shadow-md transition-shadow">
      <div class="w-24 h-24 bg-gradient-to-br from-accent to-accent-dark rounded-lg flex-shrink-0 overflow-hidden flex items-center justify-center">
        ${item.image ? `<img src="${item.image}" alt="${item.name}" class="cart-item-image" onerror="this.style.display='none'">` : ''}
        ${!item.image ? `<span class="text-4xl">üç≤</span>` : ''}
      </div>
      <div class="flex-1 min-w-0">
        <h4 class="font-semibold text-dark text-lg mb-1">${item.name}</h4>
        <p class="text-sm text-gray-600 mb-3">‚Ç±${item.price.toFixed(2)} each</p>
        <div class="flex items-center gap-2 bg-white rounded-lg p-1 w-fit">
          <button onclick="updateQuantity(${index}, -1)" class="w-8 h-8 bg-gray-200 rounded-full hover:bg-accent hover:text-white transition-colors flex items-center justify-center font-bold">‚àí</button>
          <span class="font-semibold w-8 text-center">${item.quantity}</span>
          <button onclick="updateQuantity(${index}, 1)" class="w-8 h-8 bg-gray-200 rounded-full hover:bg-accent hover:text-white transition-colors flex items-center justify-center font-bold">+</button>
        </div>
      </div>
      <div class="text-right flex-shrink-0">
        <p class="font-bold text-lg text-accent mb-2">‚Ç±${(item.price * item.quantity).toFixed(2)}</p>
        <button onclick="removeItem(${index})" class="text-xs text-red-500 hover:text-red-700 font-medium hover:underline">Remove</button>
      </div>
    </div>
  `).join('');
  
  updateTotals();
}

function updateQuantity(index, change) {
  if (cart[index]) {
    cart[index].quantity += change;
    if (cart[index].quantity <= 0) {
      cart.splice(index, 1);
    }
    localStorage.setItem('kusinaCart', JSON.stringify(cart));
    displayCart();
  }
}

function removeItem(index) {
  cart.splice(index, 1);
  localStorage.setItem('kusinaCart', JSON.stringify(cart));
  displayCart();
}

function updateTotals() {
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const deliveryOption = document.getElementById('delivery-option').value;
  const delivery = deliveryOption === 'delivery' ? DELIVERY_FEE : 0;
  
  // Calculate voucher discount
  const voucherDiscount = calculateVoucherDiscount(subtotal, delivery);
  
  // Apply discount to subtotal
  const discountedSubtotal = subtotal - (appliedVoucher && appliedVoucher.type !== 'shipping' ? voucherDiscount : 0);
  
  // Adjust delivery fee if free shipping voucher
  const finalDelivery = appliedVoucher && appliedVoucher.type === 'shipping' ? 0 : delivery;
  
  const tax = discountedSubtotal * TAX_RATE;
  const total = discountedSubtotal + finalDelivery + tax;
  
  document.getElementById('subtotal').textContent = `‚Ç±${subtotal.toFixed(2)}`;
  document.getElementById('delivery-fee').textContent = `‚Ç±${finalDelivery.toFixed(2)}`;
  document.getElementById('tax').textContent = `‚Ç±${tax.toFixed(2)}`;
  document.getElementById('total').textContent = `‚Ç±${total.toFixed(2)}`;
  
  if (appliedVoucher) {
    document.getElementById('voucher-discount').textContent = `-‚Ç±${voucherDiscount.toFixed(2)}`;
  }
}

function togglePaymentForm() {
  const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
  const cardForm = document.getElementById('card-payment-form');
  const gcashInfo = document.getElementById('gcash-payment-info');
  
  if (paymentMethod === 'card') {
    cardForm.classList.remove('hidden');
    gcashInfo.classList.add('hidden');
  } else {
    cardForm.classList.add('hidden');
    gcashInfo.classList.remove('hidden');
  }
}

function formatCardNumber(input) {
  let value = input.value.replace(/\s/g, '');
  let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
  input.value = formattedValue;
}

function formatExpiry(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length >= 2) {
    value = value.slice(0, 2) + '/' + value.slice(2, 4);
  }
  input.value = value;
}

function validateForm() {
  const name = document.getElementById('customer-name').value.trim();
  const email = document.getElementById('customer-email').value.trim();
  const phone = document.getElementById('customer-phone').value.trim();
  
  if (!name || !email || !phone) {
    alert('Please fill in all customer information fields');
    return false;
  }
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    alert('Please enter a valid email address');
    return false;
  }
  
  if (cart.length === 0) {
    alert('Your cart is empty');
    return false;
  }
  
  return true;
}

async function initiateCheckout() {
  if (!validateForm()) return;
  
  const token = getAuthToken();
  if (!token) {
    alert('Please login first to proceed with checkout');
    window.location.href = 'login.html';
    return;
  }
  
  const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
  const btn = document.getElementById('checkout-btn');
  
  btn.disabled = true;
  btn.innerHTML = '<span class="flex items-center justify-center gap-2">Processing... ‚è≥</span>';
  
  try {
    if (paymentMethod === 'card') {
      await processCardPayment(token);
    } else {
      await processGCashPayment(token);
    }
  } catch (error) {
    console.error('Checkout error:', error);
    alert('Error: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="flex items-center justify-center gap-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>Proceed to Payment</span>';
  }
}

async function processCardPayment(token) {
  console.log('üí≥ Processing card payment...');
  
  const name = document.getElementById('customer-name').value.trim();
  const email = document.getElementById('customer-email').value.trim();
  const phone = document.getElementById('customer-phone').value.trim();
  const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
  const cardExpiry = document.getElementById('card-expiry').value;
  const cardCvc = document.getElementById('card-cvc').value;
  const cardName = document.getElementById('card-name').value;
  const deliveryOption = document.getElementById('delivery-option').value;
  
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const delivery = deliveryOption === 'delivery' ? DELIVERY_FEE : 0;
  const voucherDiscount = calculateVoucherDiscount(subtotal, delivery);
  const discountedSubtotal = subtotal - (appliedVoucher && appliedVoucher.type !== 'shipping' ? voucherDiscount : 0);
  const finalDelivery = appliedVoucher && appliedVoucher.type === 'shipping' ? 0 : delivery;
  const tax = discountedSubtotal * TAX_RATE;
  const total = discountedSubtotal + finalDelivery + tax;
  
  const amountInCentavos = Math.round(total * 100);

  try {
    console.log('Creating payment intent...');
    const intentResponse = await fetch(`${API_URL}/paymongo/create-payment-intent`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        amount: amountInCentavos,
        currency: 'PHP',
        customer: { name, email },
        card: {
          number: cardNumber,
          exp_month: parseInt(cardExpiry.split('/')[0]),
          exp_year: parseInt('20' + cardExpiry.split('/')[1]),
          cvc: cardCvc
        }
      })
    });

    if (!intentResponse.ok) {
      const error = await intentResponse.json();
      throw new Error(error.message || 'Failed to create payment intent');
    }

    const intentData = await intentResponse.json();
    console.log('‚úÖ Payment intent created:', intentData);

    console.log('Saving order to database...');
    const orderData = {
      customer_name: name,
      customer_email: email,
      customer_phone: phone,
      items: cart,
      subtotal: subtotal,
      delivery_fee: finalDelivery,
      tax: tax,
      total: total,
      delivery_option: deliveryOption,
      payment_method: 'card',
      payment_status: 'paid',
      payment_intent_id: intentData.paymentIntentId,
      voucher_code: appliedVoucher ? appliedVoucher.id : null,
      voucher_discount: voucherDiscount
    };

    const orderResponse = await fetch(`${API_URL}/create-order`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(orderData)
    });

    const result = await orderResponse.json();
    
    if (!orderResponse.ok || !result.success) {
      throw new Error(result.message || 'Failed to create order');
    }

    console.log('‚úÖ Order saved:', result.order_id);
    showSuccessModal(result.order_id);
    cart = [];
    localStorage.removeItem('kusinaCart');
    localStorage.removeItem('selectedVoucher');
    
    setTimeout(() => {
      window.location.href = 'dashboard.html?refresh=true';
    }, 3000);
    
  } catch (error) {
    console.error('‚ùå Card payment error:', error);
    alert('Payment failed: ' + error.message);
    throw error;
  }
}

async function processGCashPayment(token) {
  console.log('üì± Processing GCash payment...');
  
  const name = document.getElementById('customer-name').value.trim();
  const email = document.getElementById('customer-email').value.trim();
  const phone = document.getElementById('customer-phone').value.trim();
  const deliveryOption = document.getElementById('delivery-option').value;
  
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const delivery = deliveryOption === 'delivery' ? DELIVERY_FEE : 0;
  const voucherDiscount = calculateVoucherDiscount(subtotal, delivery);
  const discountedSubtotal = subtotal - (appliedVoucher && appliedVoucher.type !== 'shipping' ? voucherDiscount : 0);
  const finalDelivery = appliedVoucher && appliedVoucher.type === 'shipping' ? 0 : delivery;
  const tax = discountedSubtotal * TAX_RATE;
  const total = discountedSubtotal + finalDelivery + tax;
  const amountInCentavos = Math.round(total * 100);

  try {
    console.log('Creating GCash payment source...');
    const sourceResponse = await fetch(`${API_URL}/paymongo/create-gcash-payment`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        amount: amountInCentavos,
        currency: 'PHP',
        customer: { name, email }
      })
    });

    if (!sourceResponse.ok) {
      const error = await sourceResponse.json();
      throw new Error(error.message || 'Failed to create GCash payment');
    }

    const sourceData = await sourceResponse.json();
    console.log('‚úÖ GCash source created:', sourceData);

    if (!sourceData.checkout_url) {
      throw new Error('No checkout URL received');
    }

    console.log('Saving order to database...');
    const orderData = {
      customer_name: name,
      customer_email: email,
      customer_phone: phone,
      items: cart,
      subtotal: subtotal,
      delivery_fee: finalDelivery,
      tax: tax,
      total: total,
      delivery_option: deliveryOption,
      payment_method: 'gcash',
      payment_status: 'pending',
      payment_source_id: sourceData.source_id,
      voucher_code: appliedVoucher ? appliedVoucher.id : null,
      voucher_discount: voucherDiscount
    };

    const orderResponse = await fetch(`${API_URL}/create-order`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(orderData)
    });

    const result = await orderResponse.json();
    
    if (!orderResponse.ok || !result.success) {
      throw new Error(result.message || 'Failed to create order');
    }

    console.log('‚úÖ Order saved:', result.order_id);
    
    cart = [];
    localStorage.removeItem('kusinaCart');
    localStorage.removeItem('selectedVoucher');
    
    window.location.href = sourceData.checkout_url;
    
  } catch (error) {
    console.error('‚ùå GCash payment error:', error);
    alert('GCash payment failed: ' + error.message);
    throw error;
  }
}

function showSuccessModal(orderId) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm';
  modal.innerHTML = `
    <div class="bg-white rounded-3xl p-8 max-w-md mx-4 shadow-2xl text-center">
      <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 success-check">
        <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-dark mb-2">Payment Successful!</h2>
      <p class="text-gray-600 mb-6">Your order has been placed and saved to the database.</p>
      <div class="bg-gray-50 rounded-lg p-4 mb-6">
        <p class="text-sm text-gray-500">Order ID</p>
        <p class="text-lg font-bold text-accent font-mono">${orderId}</p>
      </div>
      ${appliedVoucher ? `<p class="text-sm text-green-600 mb-4">‚úì Voucher ${appliedVoucher.id} applied!</p>` : ''}
      <p class="text-sm text-gray-500">Redirecting to dashboard...</p>
    </div>
  `;
  document.body.appendChild(modal);
}

window.addEventListener('DOMContentLoaded', () => {
  loadCartFromStorage();
  loadSelectedVoucher();
  displayCart();
});
</script>

</body>
</html>