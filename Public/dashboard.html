<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard - Kusina ni Katya</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  * { font-family: 'Poppins', sans-serif; }
  
  body { 
    background: #fafafa;
    color: #1f2937;
  }
  
  .card {
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    padding: 20px;
    transition: all 0.3s;
  }
  
  .card:hover {
    border-color: #cda45e;
    box-shadow: 0 8px 24px rgba(205, 164, 94, 0.15);
  }
  
  .btn {
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
  }
  
  .btn-primary { 
    background: linear-gradient(135deg, #cda45e 0%, #b8924e 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(205, 164, 94, 0.3);
  }
  .btn-primary:hover { 
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(205, 164, 94, 0.4);
  }
  
  .btn-secondary { 
    background: #f3f4f6; 
    color: #374151; 
    border: 1px solid #e5e7eb;
  }
  .btn-secondary:hover { background: #e5e7eb; }
  
  .badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 11px;
    font-weight: 700;
  }
  
  .badge-pending { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; }
  .badge-paid { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; }
  .badge-failed { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b; }
  
  .filter-btn {
    padding: 8px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    border: 2px solid #e5e7eb;
    background: white;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .filter-btn:hover {
    border-color: #cda45e;
    color: #cda45e;
    transform: translateY(-2px);
  }
  
  .filter-btn.active {
    background: linear-gradient(135deg, #cda45e 0%, #b8924e 100%);
    color: white;
    border-color: #cda45e;
    box-shadow: 0 4px 12px rgba(205, 164, 94, 0.3);
  }
  
  .status-indicator {
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
  }
  
  .status-connected { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; }
  .status-disconnected { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b; }
  
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(8px);
  }
  
  .modal-content {
    background: white;
    border-radius: 16px;
    padding: 28px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideIn 0.3s ease-out;
  }
  
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  
  #toast {
    position: fixed;
    right: 24px;
    bottom: 24px;
    background: #1f2937;
    color: white;
    padding: 12px 20px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 500;
    z-index: 1100;
    display: none;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  }
</style>
</head>

<body>

<header class="bg-white border-b sticky top-0 z-50 backdrop-blur-md bg-white/80">
  <nav class="max-w-7xl mx-auto px-6">
    <div class="flex justify-between items-center h-16">
      <div class="flex items-center gap-3">
        <img src="assets/images/logo1.png" alt="Logo" class="w-12 h-12 rounded-full shadow-lg" />
        <div>
          <h1 class="text-lg font-bold bg-gradient-to-r from-[#cda45e] to-[#b8924e] bg-clip-text text-transparent">Dashboard</h1>
          <div class="text-xs text-gray-500">Kusina ni Katya</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div id="connection-status" class="status-indicator status-disconnected">
          <span id="connection-text">Connecting</span>
        </div>
        <a href="admin-menu.html" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-[#cda45e] rounded-lg hover:bg-gray-50 transition">Menu</a>
        <a href="admin-users.html" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-[#cda45e] rounded-lg hover:bg-gray-50 transition">Users</a>
        <button onclick="location.reload()" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-[#cda45e] rounded-lg hover:bg-gray-50 transition">Refresh</button>
        <div class="border-l pl-3 ml-3 flex items-center gap-2">
          <div class="text-sm font-semibold" id="user-name">Loading</div>
          <button onclick="logout()" class="px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition">Logout</button>
        </div>
      </div>
    </div>
  </nav>
</header>

<main class="max-w-7xl mx-auto px-6 py-6">

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="card">
      <div class="text-xs text-gray-500 mb-1">Total Orders</div>
      <div class="text-2xl font-semibold" id="total-orders">0</div>
    </div>
    <div class="card">
      <div class="text-xs text-gray-500 mb-1">Revenue</div>
      <div class="text-2xl font-semibold text-green-600" id="total-revenue">₱0</div>
    </div>
    <div class="card">
      <div class="text-xs text-gray-500 mb-1">Pending</div>
      <div class="text-2xl font-semibold text-yellow-600" id="pending-orders">0</div>
    </div>
    <div class="card">
      <div class="text-xs text-gray-500 mb-1">Completed</div>
      <div class="text-2xl font-semibold text-blue-600" id="completed-orders">0</div>
    </div>
  </div>

  <div class="mb-4 flex gap-2 flex-wrap">
    <button onclick="filterOrders('all', this)" class="filter-btn active">All</button>
    <button onclick="filterOrders('pending', this)" class="filter-btn">Pending</button>
    <button onclick="filterOrders('paid', this)" class="filter-btn">Paid</button>
    <button onclick="filterOrders('failed', this)" class="filter-btn">Failed</button>
  </div>

  <div class="mb-4 flex gap-2">
    <input type="text" id="search-input" placeholder="Search orders..." 
           onkeyup="searchOrders()" 
           class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg text-sm focus:border-[#cda45e] focus:outline-none transition">
    <button onclick="exportOrders()" class="btn btn-secondary">Export CSV</button>
  </div>

  <div class="card">
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b text-left text-xs text-gray-500">
            <th class="pb-3 font-medium">Order ID</th>
            <th class="pb-3 font-medium">Customer</th>
            <th class="pb-3 font-medium">Total</th>
            <th class="pb-3 font-medium">Payment</th>
            <th class="pb-3 font-medium">Delivery</th>
            <th class="pb-3 font-medium">Date</th>
            <th class="pb-3 font-medium">Actions</th>
          </tr>
        </thead>
        <tbody id="orders-table-body">
          <tr>
            <td colspan="7" class="py-12 text-center text-gray-400">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</main>

<div id="status-modal" class="modal-overlay hidden" onclick="closeStatusModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 class="text-lg font-semibold mb-4">Update Payment Status</h3>
    <p class="text-sm text-gray-600 mb-4">Order: <span id="modal-order-id-display" class="font-mono font-bold"></span></p>
    <input type="hidden" id="modal-order-id">
    
    <div class="space-y-2 mb-6">
      <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
        <input type="radio" name="status" value="pending" class="mr-3">
        <span class="text-sm font-medium">Pending</span>
      </label>
      <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
        <input type="radio" name="status" value="paid" class="mr-3">
        <span class="text-sm font-medium">Paid</span>
      </label>
      <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
        <input type="radio" name="status" value="failed" class="mr-3">
        <span class="text-sm font-medium">Failed</span>
      </label>
    </div>
    
    <div class="flex gap-2">
      <button onclick="closeStatusModal()" class="flex-1 btn btn-secondary">Cancel</button>
      <button onclick="updateOrderStatus()" class="flex-1 btn btn-primary">Update</button>
    </div>
  </div>
</div>

<div id="delivery-status-modal" class="modal-overlay hidden" onclick="closeDeliveryStatusModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 class="text-lg font-semibold mb-4">Update Delivery Status</h3>
    <p class="text-sm text-gray-600 mb-4">Order: <span id="delivery-modal-order-id-display" class="font-mono font-bold"></span></p>
    <input type="hidden" id="delivery-modal-order-id">
    
    <div class="space-y-2 mb-6">
      <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
        <input type="radio" name="delivery-status" value="placed" class="mr-3">
        <span class="text-sm font-medium">Placed</span>
      </label>
      <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
        <input type="radio" name="delivery-status" value="preparing" class="mr-3">
        <span class="text-sm font-medium">Preparing</span>
      </label>
      <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
        <input type="radio" name="delivery-status" value="delivering" class="mr-3">
        <span class="text-sm font-medium">Delivering</span>
      </label>
      <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
        <input type="radio" name="delivery-status" value="delivered" class="mr-3">
        <span class="text-sm font-medium">Delivered</span>
      </label>
      <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
        <input type="radio" name="delivery-status" value="cancelled" class="mr-3">
        <span class="text-sm font-medium">Cancelled</span>
      </label>
    </div>
    
    <div class="flex gap-2">
      <button onclick="closeDeliveryStatusModal()" class="flex-1 btn btn-secondary">Cancel</button>
      <button onclick="updateDeliveryStatus()" class="flex-1 btn btn-primary">Update</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
  let token = null;
  let allOrders = [];
  let displayedOrders = [];
  let currentFilter = 'all';
  let socket = null;

  document.addEventListener('DOMContentLoaded', async () => {
    token = localStorage.getItem('adminToken');
    if (!token) {
      window.location.href = 'login.html';
      return;
    }
    
    await loadUserInfo();
    await loadOrders();
    await loadStats();
    initializeSocket();
  });

  function initializeSocket() {
    try {
      socket = io("http://localhost:3000", { 
        transports: ["websocket", "polling"], 
        auth: { token: token }
      });
      
      socket.on('connect', () => updateConnectionStatus(true));
      socket.on('disconnect', () => updateConnectionStatus(false));
      socket.on('new-order', () => { loadOrders(); loadStats(); });
      socket.on('order-status-updated', () => { loadOrders(); loadStats(); });
    } catch(err) { 
      updateConnectionStatus(false); 
    }
  }

  function updateConnectionStatus(connected) {
    const indicator = document.getElementById('connection-status');
    const text = document.getElementById('connection-text');
    if (connected) {
      indicator.className = 'status-indicator status-connected';
      text.textContent = 'Connected';
    } else {
      indicator.className = 'status-indicator status-disconnected';
      text.textContent = 'Disconnected';
    }
  }

  async function loadUserInfo() {
    try {
      const res = await fetch('/auth/me', { 
        headers: { 'Authorization': `Bearer ${token}` } 
      });
      
      if (!res.ok) {
        localStorage.removeItem('adminToken');
        window.location.href = 'login.html';
        return;
      }
      
      const data = await res.json();
      if (data.success && data.user) {
        document.getElementById('user-name').textContent = data.user.name || 'Admin';
      }
    } catch(e) { 
      console.error('User load error:', e);
    }
  }

  async function loadOrders() {
    try {
      const res = await fetch('/api/admin/get-all-orders', { 
        headers: { 'Authorization': `Bearer ${token}` } 
      });
      
      if (!res.ok) return;
      
      const data = await res.json();
      allOrders = data.orders || [];
      displayedOrders = allOrders;
      renderOrders();
    } catch(e) { 
      console.error('Orders error:', e);
    }
  }

  function renderOrders() {
    const tbody = document.getElementById('orders-table-body');
    if (!tbody) return;
    
    let filtered = displayedOrders.filter(order => {
      if (currentFilter === 'all') return true;
      return order.payment_status === currentFilter;
    });

    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="py-12 text-center text-gray-400">No orders</td></tr>';
      return;
    }

    tbody.innerHTML = '';
    filtered.forEach(order => {
      const tr = document.createElement('tr');
      tr.className = 'border-b hover:bg-gray-50';
      tr.innerHTML = `
        <td class="py-3 font-mono text-xs">${order.order_id}</td>
        <td class="py-3 text-sm">${order.customer_name || '-'}</td>
        <td class="py-3 font-semibold">₱${parseFloat(order.total || 0).toFixed(2)}</td>
        <td class="py-3"><span class="badge badge-${order.payment_status}">${order.payment_status}</span></td>
        <td class="py-3"><span class="badge" style="background: #e0e7ff; color: #4338ca;">${order.delivery_status || 'placed'}</span></td>
        <td class="py-3 text-xs text-gray-500">${order.created_at ? new Date(order.created_at).toLocaleDateString() : '-'}</td>
        <td class="py-3">
          <div class="flex gap-1">
            <button onclick="openStatusModal('${order.order_id}','${order.payment_status}')" class="btn btn-secondary text-xs">Payment</button>
            <button onclick="openDeliveryStatusModal('${order.order_id}','${order.delivery_status || 'placed'}')" class="btn btn-primary text-xs">Delivery</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function loadStats() {
    const total = allOrders.length;
    const pending = allOrders.filter(o => o.payment_status === 'pending').length;
    const paid = allOrders.filter(o => o.payment_status === 'paid').length;
    const revenue = allOrders.filter(o => o.payment_status === 'paid').reduce((sum, o) => sum + parseFloat(o.total || 0), 0);

    document.getElementById('total-orders').textContent = total;
    document.getElementById('pending-orders').textContent = pending;
    document.getElementById('completed-orders').textContent = paid;
    document.getElementById('total-revenue').textContent = `₱${revenue.toFixed(2)}`;
  }

  function searchOrders() {
    const val = document.getElementById('search-input').value.toLowerCase();
    displayedOrders = allOrders.filter(o => 
      o.order_id.toLowerCase().includes(val) || 
      (o.customer_name || '').toLowerCase().includes(val)
    );
    renderOrders();
  }

  function filterOrders(status, btn) {
    currentFilter = status;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderOrders();
  }

  function openStatusModal(id, status) {
    document.getElementById('status-modal').classList.remove('hidden');
    document.getElementById('modal-order-id').value = id;
    document.getElementById('modal-order-id-display').textContent = id;
    document.querySelectorAll('input[name="status"]').forEach(r => r.checked = r.value === status);
  }
  
  function closeStatusModal(e) { 
    if (!e || e.target === e.currentTarget) {
      document.getElementById('status-modal').classList.add('hidden'); 
    }
  }

  function openDeliveryStatusModal(id, status) {
    document.getElementById('delivery-status-modal').classList.remove('hidden');
    document.getElementById('delivery-modal-order-id').value = id;
    document.getElementById('delivery-modal-order-id-display').textContent = id;
    document.querySelectorAll('input[name="delivery-status"]').forEach(r => r.checked = r.value === status);
  }
  
  function closeDeliveryStatusModal(e) { 
    if (!e || e.target === e.currentTarget) {
      document.getElementById('delivery-status-modal').classList.add('hidden'); 
    }
  }

  async function updateOrderStatus() {
    const id = document.getElementById('modal-order-id').value;
    const selected = document.querySelector('input[name="status"]:checked');
    if (!selected) return;
    
    try {
      const res = await fetch(`/api/admin/update-order-status`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ order_id: id, status: selected.value })
      });
      
      const data = await res.json();
      if (data.success) { 
        showToast('Status updated', 'success'); 
        await loadOrders(); 
        await loadStats(); 
        closeStatusModal(); 
      }
    } catch(e) { 
      showToast('Update failed', 'error'); 
    }
  }

  async function updateDeliveryStatus() {
    const id = document.getElementById('delivery-modal-order-id').value;
    const selected = document.querySelector('input[name="delivery-status"]:checked');
    if (!selected) return;
    
    try {
      const res = await fetch(`/api/admin/update-delivery-status`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ order_id: id, delivery_status: selected.value })
      });
      
      const data = await res.json();
      if (data.success) { 
        showToast('Delivery updated', 'success'); 
        await loadOrders(); 
        closeDeliveryStatusModal(); 
      }
    } catch(e) { 
      showToast('Update failed', 'error'); 
    }
  }

  function logout() {
    if (confirm('Logout?')) {
      localStorage.removeItem('adminToken');
      window.location.href = 'login.html';
    }
  }

  function exportOrders() {
    if (allOrders.length === 0) return;
    
    let csv = 'Order ID,Customer,Total,Payment,Delivery,Date\n';
    allOrders.forEach(o => {
      csv += `"${o.order_id}","${o.customer_name}",${o.total},"${o.payment_status}","${o.delivery_status}","${new Date(o.created_at).toLocaleString()}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `orders_${Date.now()}.csv`;
    link.click();
    URL.revokeObjectURL(url);
    
    showToast('Exported', 'success');
  }

  function showToast(msg, type = 'info') {
    const toast = document.getElementById('toast');
    if (!toast) return;
    
    toast.textContent = msg;
    
    if (type === 'success') {
      toast.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
    } else if (type === 'error') {
      toast.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
    } else {
      toast.style.background = '#1f2937';
    }
    
    toast.style.display = 'block';
    
    clearTimeout(toast.hideTimeout);
    toast.hideTimeout = setTimeout(() => { 
      toast.style.display = 'none'; 
    }, 3000);
  }
</script>

</body>
</html>