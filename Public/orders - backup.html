<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>My Orders - Kusina ni Katya</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          accent: '#cda45e',
          'accent-light': '#e5b66a',
          'accent-dark': '#b8924e',
          dark: '#1a1a1a',
          'dark-light': '#2d2d2d',
          'light-bg': '#fef9f3',
          'cream': '#f5e9da',
        },
        fontFamily: {
          Inter: ['Inter', 'sans-serif'],
        }
      }
    }
  }
</script>

<style>
  @font-face {
    font-family: 'Quiapo';
    src: url('assets/fonts/Quiapo_Free.ttf') format('opentype');
  }
  body { font-family: 'Inter', sans-serif; }
  .font-quiapo { font-family: 'Quiapo', 'Inter', sans-serif; }
  .glass-effect { backdrop-filter: blur(10px); }
  .pattern-bg {
    background-color: #fef3f3;
    background-image:
      radial-gradient(circle at 25% 25%, rgba(205, 164, 94, 0.03) 0%, transparent 50%),
      radial-gradient(circle at 75% 75%, rgba(205, 164, 94, 0.03) 0%, transparent 50%);
  }
  .order-card { 
    transition: all 0.3s ease;
    animation: slideIn 0.3s ease-out;
  }
  .order-card:hover { 
    transform: translateY(-3px); 
    box-shadow: 0 12px 24px rgba(205, 164, 94, 0.15); 
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  #tracking-map {
    height: 500px;
    width: 100%;
    border-radius: 16px;
    z-index: 1;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }
  .leaflet-container { z-index: 1 !important; }

  @keyframes riderPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }
  .rider-marker { animation: riderPulse 2s ease-in-out infinite; }

  .timeline-item {
    position: relative;
    padding-left: 45px;
    padding-bottom: 28px;
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 40px;
    bottom: 0;
    width: 3px;
    background: linear-gradient(to bottom, #cda45e, #e5e7eb);
  }
  .timeline-item:last-child::before { display: none; }
  .timeline-item:last-child { padding-bottom: 0; }
  .timeline-dot {
    position: absolute;
    left: 0;
    top: 8px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 4px solid #e5e7eb;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 2;
  }
  .timeline-dot.active {
    background: #cda45e;
    border-color: #cda45e;
    box-shadow: 0 0 0 6px rgba(205, 164, 94, 0.2);
    animation: pulse-ring 2s ease-in-out infinite;
  }
  .timeline-dot.completed {
    background: #10b981;
    border-color: #10b981;
    color: white;
  }
  .timeline-dot.completed::after {
    content: '‚úì';
    color: white;
    font-size: 16px;
    font-weight: bold;
  }
  @keyframes pulse-ring {
    0% { box-shadow: 0 0 0 0 rgba(205, 164, 94, 0.4); }
    50% { box-shadow: 0 0 0 15px rgba(205, 164, 94, 0); }
    100% { box-shadow: 0 0 0 0 rgba(205, 164, 94, 0); }
  }

  .route-line {
    stroke-dasharray: 10, 5;
    animation: dash 20s linear infinite;
  }
  @keyframes dash {
    to { stroke-dashoffset: -100; }
  }

  .eta-badge { animation: float 3s ease-in-out infinite; }
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-5px); }
  }

  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 9999;
    animation: slideInRight 0.3s ease-out;
  }
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  .skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }
  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
  <style>
.tracking-progress-container {
  position: relative;
  width: 100%;
  height: 8px;
  background: #e5e7eb;
  border-radius: 999px;
  overflow: hidden;
  margin: 16px 0;
}

.tracking-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #cda45e 0%, #e5b66a 100%);
  border-radius: 999px;
  transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 2px 8px rgba(205, 164, 94, 0.3);
  position: relative;
}

.tracking-progress-bar::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.3),
    transparent
  );
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.tracking-status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.3s ease;
}

.tracking-message-box {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border-left: 4px solid #3b82f6;
  padding: 12px 16px;
  border-radius: 8px;
  margin: 12px 0;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateX(-10px); }
  to { opacity: 1; transform: translateX(0); }
}

</style>
</head>
<body class="bg-light-bg pattern-bg text-dark overflow-x-hidden">

<!-- HEADER -->
<header class="sticky top-0 z-50 glass-effect bg-white/80 shadow-md transition-all duration-300">
  <nav class="max-w-full mx-auto px-6 lg:px-12">
    <div class="flex justify-between items-center h-20">
      <div class="flex items-center space-x-3 flex-shrink-0">
        <a href="index.html" class="flex items-center space-x-3">
          <img src="assets/images/logo1.png" alt="Logo" class="w-14 h-14 object-contain rounded-full shadow-lg" />
        </a>
        <div class="hidden sm:block">
          <h1 class="font-quiapo text-2xl font-bold text-accent tracking-widest">Kusina ni Katya</h1>
          <p class="text-xs text-gray-600">Authentic Filipino Cuisine</p>
        </div>
      </div>
      
      <div class="hidden lg:flex items-center space-x-3">
        <a href="index.html" class="text-dark-light hover:text-accent font-medium transition-colors text-[15px]">Home</a>
        <a href="menu.html" class="text-dark-light hover:text-accent font-medium transition-colors text-[15px]">Menu</a>
        <a href="orders.html" class="text-accent font-medium transition-colors text-[15px]">Orders</a>
        <a href="#contact" class="text-dark-light hover:text-accent font-medium transition-colors text-[15px]">Contact</a>
        <a href="cart.html" class="px-4 py-2 bg-gradient-to-r from-accent to-accent-dark text-white font-semibold rounded-full hover:shadow-lg hover:scale-105 transition-all text-[13px]">
          üõí View Cart (<span id="cart-count">0</span>)
        </a>
        
        <div id="auth-buttons" class="flex items-center gap-2">
          <a href="login.html" class="px-5 py-2.5 bg-white border-2 border-accent text-accent font-semibold rounded-full hover:bg-accent hover:text-white transition-all text-[13px]">Log In</a>
          <a href="signup.html" class="px-5 py-2.5 bg-gradient-to-r from-accent to-accent-dark text-white font-semibold rounded-full hover:shadow-lg transition-all text-[13px]">Sign Up</a>
        </div>
        
        <div id="user-profile" class="hidden items-center gap-2">
          <a href="profile.html" class="flex items-center space-x-2 px-3 py-2 bg-accent/10 rounded-full hover:bg-accent/20 transition-all cursor-pointer">
            <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
              <span id="user-initial" class="text-white font-bold text-xs">U</span>
            </div>
            <span id="user-name" class="text-dark font-semibold text-[13px]">User</span>
          </a>
          <button onclick="logout()" class="px-5 py-2.5 bg-red-500 text-white font-semibold rounded-full hover:bg-red-600 transition-all text-[13px]">Logout</button>
        </div>
      </div>
      
      <button onclick="toggleMobileMenu()" class="lg:hidden p-2 rounded-lg hover:bg-gray-100">
        <svg class="w-6 h-6 text-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>
    
    <div id="mobile-menu" class="hidden lg:hidden pb-6">
      <div class="flex flex-col space-y-3">
        <a href="index.html" class="text-dark-light hover:text-accent font-medium py-2">Home</a>
        <a href="menu.html" class="text-dark-light hover:text-accent font-medium py-2">Menu</a>
        <a href="orders.html" class="text-accent font-medium py-2">Orders</a>
        <a href="cart.html" class="text-dark-light hover:text-accent font-medium py-2">üõí Cart (<span id="mobile-cart-count">0</span>)</a>
        
        <div id="mobile-auth-buttons" class="flex flex-col space-y-3 pt-3 border-t border-gray-200">
          <a href="login.html" class="px-6 py-2.5 bg-gradient-to-r from-accent to-accent-dark text-white font-semibold rounded-full text-center">Log In</a>
          <a href="signup.html" class="px-6 py-2.5 border-2 border-accent text-accent font-semibold rounded-full hover:bg-accent hover:text-white text-center">Sign Up</a>
        </div>
        
        <div id="mobile-user-profile" class="hidden flex-col space-y-3 pt-3 border-t border-gray-200">
          <a href="profile.html" class="flex items-center space-x-3 px-4 py-2 bg-accent/10 rounded-full">
            <div class="w-10 h-10 bg-accent rounded-full flex items-center justify-center">
              <span id="mobile-user-initial" class="text-white font-bold">U</span>
            </div>
            <span id="mobile-user-name" class="text-dark font-semibold">User</span>
          </a>
          <button onclick="logout()" class="px-6 py-2.5 bg-red-500 text-white font-semibold rounded-full text-center">Logout</button>
        </div>
      </div>
    </div>
  </nav>
</header>

<!-- HERO -->
<section class="py-8 px-4 sm:px-6 lg:px-8 bg-gradient-to-br from-cream/30 to-accent-light/10">
  <div class="max-w-7xl mx-auto">
    <h1 class="font-quiapo text-4xl md:text-5xl font-bold text-dark mb-2">
      My <span class="text-accent">Orders</span>
    </h1>
    <div class="w-24 h-1 bg-gradient-to-r from-accent-dark via-accent to-accent-light rounded-full mb-3"></div>
    <p class="text-gray-600 text-base md:text-lg">Track and manage all your orders in real-time</p>
  </div>
</section>

<!-- CONTENT -->
<section class="py-8 px-4 sm:px-6 lg:px-8">
  <div class="max-w-7xl mx-auto">
    
    <!-- Filters -->
    <div class="mb-6 flex flex-wrap gap-3 bg-white rounded-2xl p-4 shadow-md">
      <button onclick="filterOrders('all')" id="filter-all" class="filter-btn px-6 py-2.5 rounded-full font-semibold bg-gradient-to-r from-accent to-accent-dark text-white transition-all">All Orders</button>
      <button onclick="filterOrders('paid')" id="filter-paid" class="filter-btn px-6 py-2.5 rounded-full font-semibold bg-gray-100 text-dark hover:bg-accent hover:text-white transition-all">Paid</button>
      <button onclick="filterOrders('pending')" id="filter-pending" class="filter-btn px-6 py-2.5 rounded-full font-semibold bg-gray-100 text-dark hover:bg-accent hover:text-white transition-all">Pending</button>
      <button onclick="filterOrders('failed')" id="filter-failed" class="filter-btn px-6 py-2.5 rounded-full font-semibold bg-gray-100 text-dark hover:bg-accent hover:text-white transition-all">Failed</button>
    </div>

    <!-- Loading Skeleton -->
    <div id="loading-skeleton" class="grid grid-cols-1 gap-6 hidden">
      <div class="bg-white rounded-xl p-6 shadow-md">
        <div class="skeleton h-6 w-32 rounded mb-3"></div>
        <div class="skeleton h-4 w-full rounded mb-2"></div>
        <div class="skeleton h-4 w-3/4 rounded mb-4"></div>
        <div class="flex justify-between">
          <div class="skeleton h-8 w-24 rounded"></div>
          <div class="skeleton h-10 w-32 rounded"></div>
        </div>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-orders" class="flex justify-center items-center py-16 hidden">
      <div class="text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-accent mx-auto mb-4"></div>
        <p class="text-gray-600 font-medium">Loading your orders...</p>
      </div>
    </div>

    <!-- Orders Container -->
    <div id="orders-container" class="grid grid-cols-1 gap-6 hidden"></div>

    <!-- Empty State -->
    <div id="empty-orders" class="hidden text-center py-16">
      <div class="bg-white rounded-3xl p-12 shadow-lg max-w-md mx-auto">
        <svg class="w-24 h-24 mx-auto mb-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
        </svg>
        <h3 class="text-2xl font-bold text-dark mb-3">No orders yet</h3>
        <p class="text-gray-600 mb-6">Start ordering delicious Filipino dishes!</p>
        <a href="menu.html" class="inline-block px-8 py-3 bg-gradient-to-r from-accent to-accent-dark text-white font-semibold rounded-full hover:shadow-xl hover:scale-105 transition-all">Browse Menu ‚Üí</a>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden">
      <div class="bg-white rounded-xl p-8 text-center shadow max-w-md mx-auto">
        <svg class="w-16 h-16 text-red-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <p class="text-gray-500 text-lg mb-4">Failed to load orders</p>
        <p id="error-message" class="text-sm text-gray-400 mb-4"></p>
        <button onclick="loadOrders(true)" class="px-6 py-3 bg-accent text-white font-semibold rounded-xl hover:bg-accent-dark transition-all">Retry</button>
      </div>
    </div>
  </div>
</section>

<!-- FOOTER -->
<footer class="bg-dark text-white py-12 px-4 sm:px-6 lg:px-8 mt-20">
  <div class="max-w-7xl mx-auto text-center">
    <h3 class="text-3xl font-bold text-accent mb-3">Kusina ni Katya</h3>
    <p class="text-gray-400 mb-4">Bringing authentic Filipino home cooking to your table since 2020.</p>
    <div class="border-t border-white/10 pt-8 text-gray-400">
      <p>&copy; 2025 Kusina ni Katya. All Rights Reserved.</p>
    </div>
  </div>
</footer>

<!-- Toast Container -->
<div id="toast-container"></div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const API_URL = 'http://localhost:3000/api';
const SILENT_REFRESH_MS = 10000;
const RESTAURANT_LOCATION = [14.6091, 121.0223];

// ============================================
// GLOBAL STATE
// ============================================
let allOrders = [];
let currentFilter = 'all';
let socket = null;
let trackingMap = null;
let restaurantMarker = null;
let customerMarker = null;
let riderMarker = null;
let routeLine = null;
let trackingOrderId = null;
let trackingInterval = null;
let riderSimulationInterval = null;
let currentRiderIndex = 0;
let routePoints = [];
let refreshTimer = null;
let socketEventListenersAdded = false;

// ============================================
// AUTH UTILITIES
// ============================================
function getCurrentUser() {
  try {
    const str = localStorage.getItem('currentUser');
    if (!str || str === 'null' || str === 'undefined') return null;
    const user = JSON.parse(str);
    return (user && user.email) ? user : null;
  } catch (err) {
    console.error('Error parsing currentUser:', err);
    return null;
  }
}

function getAuthToken() {
  try {
    return sessionStorage.getItem('authToken') || 
           localStorage.getItem('authToken') || 
           localStorage.getItem('adminToken') || 
           null;
  } catch (err) {
    console.error('Error getting auth token:', err);
    return null;
  }
}

function isUserAuthenticated() {
  const user = getCurrentUser();
  const token = getAuthToken();
  return !!(user && user.email && token);
}

function redirectToLogin() {
  alert('Please log in to view your orders.');
  window.location.href = 'login.html';
}

function updateUIForUser() {
  const user = getCurrentUser();
  if (!user) return;

  const authButtons = document.getElementById('auth-buttons');
  const userProfile = document.getElementById('user-profile');
  const mobileAuth = document.getElementById('mobile-auth-buttons');
  const mobileUser = document.getElementById('mobile-user-profile');

  if (authButtons) authButtons.classList.add('hidden');
  if (userProfile) {
    userProfile.classList.remove('hidden');
    userProfile.classList.add('flex');
  }
  if (mobileAuth) mobileAuth.classList.add('hidden');
  if (mobileUser) {
    mobileUser.classList.remove('hidden');
    mobileUser.classList.add('flex');
  }

  const initial = user.name ? user.name.charAt(0).toUpperCase() : 'U';
  const userName = user.name || 'User';

  const elements = [
    { id: 'user-initial', value: initial },
    { id: 'user-name', value: userName },
    { id: 'mobile-user-initial', value: initial },
    { id: 'mobile-user-name', value: userName }
  ];

  elements.forEach(el => {
    const elem = document.getElementById(el.id);
    if (elem) elem.textContent = el.value;
  });
}

function getCartKey() {
  try {
    const userStr = localStorage.getItem('currentUser');
    if (!userStr || userStr === 'null' || userStr === 'undefined') {
      return 'kusinaCart_guest';
    }
    const user = JSON.parse(userStr);
    return (user && user.email) ? `kusinaCart_${user.email}` : 'kusinaCart_guest';
  } catch (e) {
    return 'kusinaCart_guest';
  }
}

function loadCartCount() {
  try {
    const cartKey = getCartKey();
    const saved = localStorage.getItem(cartKey);
    const cartItems = saved ? JSON.parse(saved) : [];
    const totalItems = Array.isArray(cartItems) 
      ? cartItems.reduce((sum, item) => sum + (item.quantity || 0), 0) 
      : 0;
    
    const desktop = document.getElementById('cart-count');
    const mobile = document.getElementById('mobile-cart-count');
    
    if (desktop) desktop.textContent = totalItems;
    if (mobile) mobile.textContent = totalItems;
  } catch (e) {
    console.error('Error loading cart count:', e);
  }
}

function logout() {
  if (confirm('Are you sure you want to logout?')) {
    try {
      localStorage.removeItem('currentUser');
      sessionStorage.removeItem('authToken');
      localStorage.removeItem('authToken');
      localStorage.removeItem('adminToken');
      window.location.href = 'login.html';
    } catch (err) {
      console.error('Logout error:', err);
      window.location.href = 'login.html';
    }
  }
}

function toggleMobileMenu() {
  const menu = document.getElementById('mobile-menu');
  if (menu) menu.classList.toggle('hidden');
}

// ============================================
// TOAST NOTIFICATIONS
// ============================================
function showToast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  if (!container) return;

  const colors = {
    success: 'border-l-4 border-green-500',
    error: 'border-l-4 border-red-500',
    info: 'border-l-4 border-blue-500',
    warning: 'border-l-4 border-yellow-500'
  };

  const toast = document.createElement('div');
  toast.className = `toast ${colors[type] || colors.info} mb-4`;
  toast.innerHTML = `
    <div class="flex items-center gap-3">
      <div class="flex-1">
        <p class="text-sm font-semibold text-dark">${escapeHtml(message)}</p>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  `;

  container.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 5000);
}

// ============================================
// API CALLS
// ============================================
async function fetchOrdersFromServer() {
  const token = getAuthToken();
  if (!token) {
    console.error('No authentication token available');
    return { success: false, message: 'No authentication token' };
  }

  try {
    console.log('üì° Fetching orders from:', `${API_URL}/orders`);

    const response = await fetch(`${API_URL}/orders`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    console.log('üì° Response status:', response.status);

    if (!response.ok) {
      const text = await response.text();
      console.error('‚ùå Response error:', text);
      return { 
        success: false, 
        message: text || `HTTP ${response.status}`,
        status: response.status
      };
    }

    const data = await response.json();
    console.log('‚úÖ Orders fetched:', data.length || 0, 'orders');
    
    return { success: true, data: Array.isArray(data) ? data : [] };
  } catch (error) {
    console.error('‚ùå Fetch orders error:', error);
    return { success: false, message: error.message || 'Network error' };
  }
}

// ============================================
// ORDERS LOADING & DISPLAY
// ============================================
async function loadOrders(showLoading = true) {
  const container = document.getElementById('orders-container');
  const loadingDiv = document.getElementById('loading-orders');
  const skeletonDiv = document.getElementById('loading-skeleton');
  const emptyDiv = document.getElementById('empty-orders');
  const errorDiv = document.getElementById('error-state');

  if (!isUserAuthenticated()) {
    hideAllContainers();
    redirectToLogin();
    return;
  }

  hideAllContainers();

  if (showLoading) {
    if (allOrders.length === 0) {
      skeletonDiv.classList.remove('hidden');
    } else {
      loadingDiv.classList.remove('hidden');
    }
  }

  const result = await fetchOrdersFromServer();

  hideAllContainers();

  if (!result.success) {
    if (result.status === 401) {
      redirectToLogin();
      return;
    }

    errorDiv.classList.remove('hidden');
    const errorMsg = document.getElementById('error-message');
    if (errorMsg) errorMsg.textContent = result.message || 'Unknown error';
    return;
  }

  const newOrders = result.data;

  if (!newOrders || newOrders.length === 0) {
    emptyDiv.classList.remove('hidden');
    allOrders = [];
    return;
  }

  container.classList.remove('hidden');

  const changed = haveOrdersChanged(allOrders, newOrders);
  if (changed) {
    allOrders = newOrders;
    filterOrders(currentFilter);
  }
}

function haveOrdersChanged(oldList, newList) {
  if (!Array.isArray(oldList) || !Array.isArray(newList)) return true;
  if (oldList.length !== newList.length) return true;

  for (let i = 0; i < newList.length; i++) {
    const newOrder = newList[i];
    const oldOrder = oldList[i];
    
    if (!oldOrder) return true;
    
    const newId = newOrder.order_id || newOrder.id;
    const oldId = oldOrder.order_id || oldOrder.id;
    
    if (newId !== oldId) return true;
    if (newOrder.delivery_status !== oldOrder.delivery_status) return true;
    if (newOrder.payment_status !== oldOrder.payment_status) return true;
  }

  return false;
}

function displayOrders(orders) {
  const container = document.getElementById('orders-container');
  if (!container) return;

  if (!orders || orders.length === 0) {
    container.innerHTML = '<p class="text-center text-gray-500 py-8">No orders found</p>';
    return;
  }

  container.innerHTML = orders.map(order => {
    const orderId = order.order_id || order.id || 'N/A';
    const dateValue = order.created_at || order.createdAt || new Date().toISOString();
    const orderDate = formatDate(dateValue);
    
    const paymentStatus = order.payment_status || order.paymentStatus || 'pending';
    const deliveryStatus = order.delivery_status || order.deliveryStatus || 'placed';
    
    const { color: statusColor, text: statusText } = getStatusDisplay(paymentStatus);
    
    const items = parseOrderItems(order.items);
    const itemNames = items.map(i => escapeHtml(i.name || 'Item')).join(', ') || 'No items';
    
    const total = parseFloat(order.total || 0).toFixed(2);

    return `
      <div class="bg-white rounded-xl p-6 shadow-md order-card" data-order-id="${orderId}">
        <div class="flex justify-between items-start mb-3">
          <div>
            <h3 class="text-lg font-bold text-dark">#${escapeHtml(orderId)}</h3>
            <p class="text-sm text-gray-500">${orderDate}</p>
            <p class="text-xs text-gray-400 mt-1">Status: ${escapeHtml(deliveryStatus)}</p>
          </div>
          <span class="px-3 py-1 ${statusColor} rounded-full text-xs font-semibold">${statusText}</span>
        </div>
        <p class="text-gray-600 text-sm mb-3 line-clamp-2">${itemNames}</p>
        <div class="flex justify-between items-center pt-3 border-t border-gray-100">
          <span class="text-lg font-bold text-accent">‚Ç±${total}</span>
          <button onclick="startTracking('${orderId}')" class="px-4 py-2 bg-gradient-to-r from-accent to-accent-dark text-white text-sm font-semibold rounded-lg hover:shadow-lg transition-all">
            üö¥ Track Order
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function parseOrderItems(items) {
  if (!items) return [];
  if (Array.isArray(items)) return items;
  
  try {
    const parsed = JSON.parse(items);
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}

function formatDate(dateString) {
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
      month: 'long', 
      day: 'numeric', 
      year: 'numeric' 
    });
  } catch {
    return 'Unknown date';
  }
}

function getStatusDisplay(status) {
  const statusLower = (status || 'pending').toLowerCase();
  
  const statusMap = {
    'paid': { color: 'bg-green-100 text-green-700', text: 'Paid' },
    'pending': { color: 'bg-yellow-100 text-yellow-700', text: 'Pending' },
    'failed': { color: 'bg-red-100 text-red-700', text: 'Failed' },
    'cancelled': { color: 'bg-gray-100 text-gray-700', text: 'Cancelled' }
  };

  return statusMap[statusLower] || statusMap.pending;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function hideAllContainers() {
  const containers = ['loading-orders', 'loading-skeleton', 'orders-container', 'empty-orders', 'error-state'];
  containers.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add('hidden');
  });
}

// ============================================
// FILTERING
// ============================================
function filterOrders(status) {
  currentFilter = status;

  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('bg-gradient-to-r', 'from-accent', 'to-accent-dark', 'text-white');
    btn.classList.add('bg-gray-100', 'text-dark');
  });

  const activeBtn = document.getElementById(`filter-${status}`);
  if (activeBtn) {
    activeBtn.classList.remove('bg-gray-100', 'text-dark');
    activeBtn.classList.add('bg-gradient-to-r', 'from-accent', 'to-accent-dark', 'text-white');
  }

  if (status === 'all') {
    displayOrders(allOrders);
  } else {
    const filtered = allOrders.filter(order => {
      const paymentStatus = (order.payment_status || order.paymentStatus || '').toLowerCase();
      return paymentStatus === status.toLowerCase();
    });
    displayOrders(filtered);
  }
}

// ============================================
// SOCKET.IO INITIALIZATION
// ============================================
function initializeSocket() {
  if (socket && socket.connected) {
    console.log('‚úÖ Socket already connected');
    return;
  }

  const token = getAuthToken();
  const user = getCurrentUser();
  
  if (!token || !user) {
    console.log('‚ö†Ô∏è No auth token or user for socket connection');
    return;
  }

  try {
    const socketUrl = 'http://localhost:3000';
    socket = io(socketUrl, {
      reconnection: true,
      reconnectionAttempts: Infinity,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      transports: ['websocket', 'polling'],
      auth: { token: token }
    });

    socket.on('connect', () => {
      console.log('üîå Socket connected:', socket.id);
      
      // Join user-specific room
      if (user && user.id) {
        socket.emit('join-user', { userId: user.id });
        console.log(`‚úÖ Joined room: user-${user.id}`);
      }
    });

    socket.on('disconnect', (reason) => {
      console.log('‚ùå Socket disconnected:', reason);
    });

    socket.on('connect_error', (error) => {
      console.error('‚ùå Socket connection error:', error);
    });

    // Add event listeners only once
    if (!socketEventListenersAdded) {
      socket.on('order-updated', handleOrderUpdate);
      socket.on('orderUpdated', handleOrderUpdate);
      socket.on('order-status-changed', handleOrderStatusChanged);
      socket.on('location-update', handleLocationUpdate);
      socket.on('new-order', handleNewOrder);
      socket.on('tracking-started', (data) => {
        console.log('‚úÖ Tracking started:', data);
      });
      
      socketEventListenersAdded = true;
      console.log('‚úÖ Socket event listeners registered');
    }

  } catch (error) {
    console.error('‚ùå Socket initialization error:', error);
  }
}

function handleOrderUpdate(payload) {
  if (!payload) return;
  
  const updatedId = payload.order_id || payload.id || payload.orderId;
  if (!updatedId) return;

  console.log('üì¶ Order update received:', updatedId, payload);

  const existingIndex = allOrders.findIndex(order => {
    const orderId = order.order_id || order.id;
    return orderId && String(orderId) === String(updatedId);
  });

  if (existingIndex !== -1) {
    allOrders[existingIndex] = { ...allOrders[existingIndex], ...payload };
  } else {
    allOrders.unshift(payload);
  }

  filterOrders(currentFilter);

  if (trackingOrderId && String(trackingOrderId) === String(updatedId)) {
    updateTrackingModalWithOrder(payload);
  }

  showToast(`Order #${updatedId} updated`, 'info');
}

function handleOrderStatusChanged(payload) {
  if (!payload) return;
  
  const orderId = payload.orderId || payload.order_id || payload.id;
  const status = payload.status || payload.delivery_status;
  
  console.log('üîÑ Order status changed:', orderId, status);

  if (!orderId) return;

  const existingIndex = allOrders.findIndex(order => {
    const id = order.order_id || order.id;
    return id && String(id) === String(orderId);
  });

  if (existingIndex !== -1) {
    if (status) allOrders[existingIndex].delivery_status = status;
    if (payload.delivery_status) allOrders[existingIndex].delivery_status = payload.delivery_status;
    
    filterOrders(currentFilter);
  }

  if (trackingOrderId && String(trackingOrderId) === String(orderId)) {
    updateTrackingModalWithOrder({ ...allOrders[existingIndex], delivery_status: status });
  }

  const statusText = status ? status.charAt(0).toUpperCase() + status.slice(1) : 'Updated';
  showToast(`Order #${orderId}: ${statusText}`, 'success');
}

function handleLocationUpdate(locationData) {
  if (!trackingOrderId || !locationData) return;

  const orderId = locationData.order_id || locationData.orderId;
  if (String(orderId) !== String(trackingOrderId)) return;

  if (locationData.latitude && locationData.longitude && riderMarker && trackingMap) {
    const newPos = [locationData.latitude, locationData.longitude];
    riderMarker.setLatLng(newPos);
    
    if (locationData.eta) {
      const etaEl = document.getElementById('eta-display');
      if (etaEl) etaEl.textContent = `${locationData.eta} mins`;
    }
  }
}

function handleNewOrder(orderData) {
  if (!orderData) return;

  const orderId = orderData.order_id || orderData.id;
  if (!orderId) return;

  const exists = allOrders.find(order => {
    const id = order.order_id || order.id;
    return id && String(id) === String(orderId);
  });

  if (!exists) {
    allOrders.unshift(orderData);
    filterOrders(currentFilter);
    showToast(`New order #${orderId} received!`, 'success');
  }
}

// ============================================
// ORDER TRACKING - MODAL
// ============================================
function startTracking(orderId) {
  const order = allOrders.find(o => {
    const id = o.order_id || o.id;
    return id && String(id) === String(orderId);
  });

  if (!order) {
    alert('Order not found. Please refresh the page.');
    return;
  }

  trackingOrderId = orderId;
  showTrackingModal(order);

  if (socket && socket.connected) {
    socket.emit('track-order', { orderId });
  }

  startTrackingPolling();
}

function showTrackingModal(order) {
  const existing = document.getElementById('tracking-modal');
  if (existing) existing.remove();

  const orderId = order.order_id || order.id || 'N/A';
  const total = parseFloat(order.total || 0).toFixed(2);
  const deliveryFee = parseFloat(order.delivery_fee || 30).toFixed(2);
  const grandTotal = (parseFloat(total)).toFixed(2);

  const modal = document.createElement('div');
  modal.id = 'tracking-modal';
  modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 overflow-y-auto';
  modal.innerHTML = `
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-6xl overflow-hidden my-8">
      <div class="flex justify-between items-center bg-gradient-to-r from-accent to-accent-dark text-white p-5">
        <div>
          <h3 class="text-2xl font-bold">üö¥ Tracking Order #${escapeHtml(orderId)}</h3>
          <p class="text-sm text-white/80 mt-1">Real-time delivery tracking</p>
        </div>
        <button id="tracking-close-btn" class="hover:bg-white/20 rounded-full p-2 transition-all">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
        <div class="lg:col-span-2">
          <div id="tracking-map" class="rounded-2xl overflow-hidden border-4 border-gray-100"></div>
          <div class="mt-4 bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-4 text-white text-center eta-badge">
            <div class="flex items-center justify-center gap-3">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <div>
                <p class="text-sm opacity-90">Estimated Arrival</p>
                <p id="eta-display" class="text-2xl font-bold">Calculating...</p>
              </div>
            </div>
          </div>
        </div>
        <div class="lg:col-span-1">
          <div class="bg-gradient-to-br from-cream/50 to-accent-light/20 rounded-2xl p-6 h-full">
            <h4 class="text-xl font-bold text-dark mb-6 flex items-center gap-2">
              <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
              </svg>
              Order Timeline
            </h4>
            <div id="order-timeline" class="space-y-0"></div>
            <div class="mt-6 pt-6 border-t border-gray-200">
              <h5 class="font-bold text-dark mb-3">Order Details</h5>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">Total:</span>
                  <span class="font-semibold">‚Ç±${total}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Delivery Fee:</span>
                  <span class="font-semibold">‚Ç±${deliveryFee}</span>
                </div>
                <div class="flex justify-between pt-2 border-t border-gray-200">
                  <span class="font-bold">Grand Total:</span>
                  <span class="font-bold text-accent">‚Ç±${grandTotal}</span>
                </div>
              </div>
            </div>
            <button id="contact-rider-btn" class="w-full mt-4 bg-gradient-to-r from-accent to-accent-dark text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
              </svg>
              Contact Support
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  const closeBtn = document.getElementById('tracking-close-btn');
  if (closeBtn) {
    closeBtn.addEventListener('click', stopTracking);
  }

  const contactBtn = document.getElementById('contact-rider-btn');
  if (contactBtn) {
    contactBtn.addEventListener('click', () => {
      alert('Contact support: support@kusinanikatya.com or call (02) 1234-5678');
    });
  }

  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      stopTracking();
    }
  });

  setTimeout(() => initializeTracking(order), 100);
}

function initializeTracking(order) {
  try {
    if (trackingMap) {
      try {
        trackingMap.remove();
      } catch (err) {
        console.error('Error removing map:', err);
      }
      trackingMap = null;
    }

    const mapEl = document.getElementById('tracking-map');
    if (!mapEl) {
      console.error('Map element not found');
      return;
    }

    trackingMap = L.map('tracking-map', { 
      zoomControl: true,
      scrollWheelZoom: false 
    }).setView(RESTAURANT_LOCATION, 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(trackingMap);

    const restaurantIcon = L.divIcon({
      className: 'custom-marker',
      html: '<div style="background: #cda45e; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"><span style="font-size:18px">üçΩÔ∏è</span></div>',
      iconSize: [40, 40]
    });
    restaurantMarker = L.marker(RESTAURANT_LOCATION, { icon: restaurantIcon }).addTo(trackingMap);
    restaurantMarker.bindPopup('<b>Kusina ni Katya</b><br>Restaurant Location');

    let customerLoc = getCustomerLocation(order);

    const customerIcon = L.divIcon({
      className: 'custom-marker',
      html: '<div style="background: #10b981; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"><span style="font-size:18px">üìç</span></div>',
      iconSize: [40, 40]
    });
    customerMarker = L.marker(customerLoc, { icon: customerIcon }).addTo(trackingMap);
    customerMarker.bindPopup('<b>Delivery Location</b><br>Your address');

    generateRoutePoints(RESTAURANT_LOCATION, customerLoc);

    routeLine = L.polyline(routePoints, { 
      color: '#cda45e', 
      weight: 4, 
      opacity: 0.7,
      dashArray: '10, 5'
    }).addTo(trackingMap);

    const riderIcon = L.divIcon({
      className: 'custom-marker rider-marker',
      html: '<div style="background: #3b82f6; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"><span style="font-size:20px">üö¥</span></div>',
      iconSize: [45, 45]
    });

    if (riderMarker) {
      try {
        trackingMap.removeLayer(riderMarker);
      } catch {}
    }

    riderMarker = L.marker(routePoints[0], { icon: riderIcon }).addTo(trackingMap);
    riderMarker.bindPopup('<b>Rider</b><br>On the way!');

    const group = L.featureGroup([restaurantMarker, customerMarker, routeLine]);
    trackingMap.fitBounds(group.getBounds().pad(0.1));

    renderTimeline(order);
    startRiderSimulation();

  } catch (error) {
    console.error('Error initializing tracking:', error);
    alert('Failed to initialize map. Please try again.');
    stopTracking();
  }
}

function getCustomerLocation(order) {
  try {
    if (order.delivery_coordinates) {
      const coords = typeof order.delivery_coordinates === 'string' 
        ? JSON.parse(order.delivery_coordinates) 
        : order.delivery_coordinates;
      
      if (Array.isArray(coords) && coords.length >= 2) {
        return [parseFloat(coords[0]), parseFloat(coords[1])];
      }
      if (coords.lat && coords.lng) {
        return [parseFloat(coords.lat), parseFloat(coords.lng)];
      }
    }

    if (order.delivery_location) {
      const loc = typeof order.delivery_location === 'string'
        ? JSON.parse(order.delivery_location)
        : order.delivery_location;
      
      if (Array.isArray(loc) && loc.length >= 2) {
        return [parseFloat(loc[0]), parseFloat(loc[1])];
      }
      if (loc.lat && loc.lng) {
        return [parseFloat(loc.lat), parseFloat(loc.lng)];
      }
    }
  } catch (err) {
    console.error('Error parsing location:', err);
  }

  return [
    RESTAURANT_LOCATION[0] + (Math.random() - 0.5) * 0.02,
    RESTAURANT_LOCATION[1] + (Math.random() - 0.5) * 0.02
  ];
}

function generateRoutePoints(start, end) {
  routePoints = [];
  const steps = 60;

  for (let i = 0; i <= steps; i++) {
    const t = i / steps;
    const lat = start[0] + (end[0] - start[0]) * t + Math.sin(t * Math.PI * 2) * 0.003;
    const lng = start[1] + (end[1] - start[1]) * t + Math.cos(t * Math.PI * 2) * 0.003;
    routePoints.push([lat, lng]);
  }
}

function startRiderSimulation() {
  currentRiderIndex = 0;
  stopRiderSimulation();

  riderSimulationInterval = setInterval(() => {
    if (!routePoints || routePoints.length === 0 || !riderMarker || !trackingMap) {
      stopRiderSimulation();
      return;
    }

    if (currentRiderIndex < routePoints.length - 1) {
      currentRiderIndex++;
      const newPos = routePoints[currentRiderIndex];
      riderMarker.setLatLng(newPos);

      const progress = currentRiderIndex / (routePoints.length - 1);
      const remainingMins = Math.max(1, Math.ceil(20 * (1 - progress)));

      const etaEl = document.getElementById('eta-display');
      if (etaEl) {
        etaEl.textContent = remainingMins > 1 ? `${remainingMins} mins` : 'Arriving soon!';
      }

      updateTimelineByProgress(progress);

    } else {
      stopRiderSimulation();
      updateTimelineStatus('delivered', 'completed');
      const etaEl = document.getElementById('eta-display');
      if (etaEl) etaEl.textContent = 'Delivered!';
    }
  }, 400);
}

function stopRiderSimulation() {
  if (riderSimulationInterval) {
    clearInterval(riderSimulationInterval);
    riderSimulationInterval = null;
  }
}

function updateTimelineByProgress(progress) {
  if (progress > 0.2 && progress < 0.4) {
    updateTimelineStatus('preparing', 'active');
  } else if (progress >= 0.4 && progress < 0.95) {
    updateTimelineStatus('preparing', 'completed');
    updateTimelineStatus('on-the-way', 'active');
  } else if (progress >= 0.95) {
    updateTimelineStatus('preparing', 'completed');
    updateTimelineStatus('on-the-way', 'completed');
    updateTimelineStatus('delivered', 'active');
  }
}

function renderTimeline(order) {
  const timeline = document.getElementById('order-timeline');
  if (!timeline) return;

  const createdDate = order.created_at ? formatDateTime(order.created_at) : '';

  const stages = [
    { id: 'order-placed', icon: 'üìã', label: 'Order Placed', status: 'completed', time: createdDate },
    { id: 'preparing', icon: 'üë®‚Äçüç≥', label: 'Preparing Food', status: 'pending', time: '' },
    { id: 'on-the-way', icon: 'üö¥', label: 'On the Way', status: 'pending', time: '' },
    { id: 'delivered', icon: '‚úÖ', label: 'Delivered', status: 'pending', time: '' }
  ];

  const deliveryStatus = (order.delivery_status || '').toLowerCase();
  
  if (deliveryStatus.includes('prepar')) {
    stages[1].status = 'active';
  } else if (deliveryStatus.includes('deliver') || deliveryStatus.includes('way')) {
    stages[1].status = 'completed';
    stages[2].status = 'active';
  } else if (deliveryStatus === 'delivered') {
    stages[1].status = 'completed';
    stages[2].status = 'completed';
    stages[3].status = 'completed';
  }

  timeline.innerHTML = stages.map(stage => `
    <div class="timeline-item" data-stage="${stage.id}">
      <div class="timeline-dot ${stage.status}" id="dot-${stage.id}"></div>
      <div class="timeline-content">
        <div class="flex items-start justify-between">
          <div>
            <h6 class="font-bold text-dark text-sm mb-1">${stage.icon} ${stage.label}</h6>
            <p class="text-xs text-gray-500" id="time-${stage.id}">
              ${stage.time || (stage.status === 'completed' ? 'Completed' : stage.status === 'active' ? 'In progress' : 'Pending')}
            </p>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

function updateTimelineStatus(stageId, status) {
  const dot = document.getElementById(`dot-${stageId}`);
  if (!dot) return;

  dot.className = `timeline-dot ${status}`;

  const timeEl = document.getElementById(`time-${stageId}`);
  if (timeEl) {
    if (status === 'active') {
      timeEl.textContent = 'In progress...';
    } else if (status === 'completed') {
      timeEl.textContent = 'Completed';
    } else {
      timeEl.textContent = 'Pending';
    }
  }
}

function formatDateTime(dateString) {
  try {
    const date = new Date(dateString);
    return date.toLocaleString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch {
    return '';
  }
}

function startTrackingPolling() {
  stopTrackingPolling();

  trackingInterval = setInterval(async () => {
    if (!trackingOrderId) {
      stopTrackingPolling();
      return;
    }

    const order = allOrders.find(o => {
      const id = o.order_id || o.id;
      return id && String(id) === String(trackingOrderId);
    });

    if (order) {
      updateTrackingModalWithOrder(order);
    }
  }, 5000);
}

function stopTrackingPolling() {
  if (trackingInterval) {
    clearInterval(trackingInterval);
    trackingInterval = null;
  }
}

function updateTrackingModalWithOrder(order) {
  if (!order) return;

  const deliveryStatus = (order.delivery_status || '').toLowerCase();
  
  if (deliveryStatus.includes('prepar')) {
    updateTimelineStatus('preparing', 'active');
  } else if (deliveryStatus.includes('deliver') || deliveryStatus.includes('way')) {
    updateTimelineStatus('preparing', 'completed');
    updateTimelineStatus('on-the-way', 'active');
  } else if (deliveryStatus === 'delivered') {
    updateTimelineStatus('preparing', 'completed');
    updateTimelineStatus('on-the-way', 'completed');
    updateTimelineStatus('delivered', 'completed');
    
    const etaEl = document.getElementById('eta-display');
    if (etaEl) etaEl.textContent = 'Delivered!';
    
    stopRiderSimulation();
  }
}

function stopTracking() {
  const modal = document.getElementById('tracking-modal');
  if (modal) {
    modal.remove();
  }

  if (socket && socket.connected && trackingOrderId) {
    socket.emit('stop-tracking', { orderId: trackingOrderId });
  }

  if (trackingMap) {
    try {
      trackingMap.remove();
    } catch (err) {
      console.error('Error removing map:', err);
    }
    trackingMap = null;
  }

  stopTrackingPolling();
  stopRiderSimulation();

  trackingOrderId = null;
  restaurantMarker = null;
  customerMarker = null;
  riderMarker = null;
  routeLine = null;
  currentRiderIndex = 0;
  routePoints = [];
}

// ============================================
// SILENT REFRESH
// ============================================
function startSilentRefresh() {
  stopSilentRefresh();
  refreshTimer = setInterval(() => {
    if (isUserAuthenticated()) {
      loadOrders(false);
    }
  }, SILENT_REFRESH_MS);
}

function stopSilentRefresh() {
  if (refreshTimer) {
    clearInterval(refreshTimer);
    refreshTimer = null;
  }
}

// ============================================
// PAGE INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üöÄ Orders page initializing...');

  if (!isUserAuthenticated()) {
    redirectToLogin();
    return;
  }

  updateUIForUser();
  loadCartCount();
  initializeSocket();
  await loadOrders(true);
  startSilentRefresh();

  console.log('‚úÖ Orders page initialized successfully');
});

// ============================================
// CLEANUP ON PAGE UNLOAD
// ============================================
window.addEventListener('beforeunload', () => {
  stopTracking();
  stopSilentRefresh();
  
  if (socket && socket.connected) {
    socket.disconnect();
  }
});
</script>
</body>
</html>