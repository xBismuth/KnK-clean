<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Shopping Cart - Kusina ni Katya</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          accent: '#cda45e',
          'accent-light': '#e5b66a',
          'accent-dark': '#b8924e',
        },
      },
    },
  }
</script>

<style>
body { font-family: 'Poppins', sans-serif; }
.step-inactive { opacity: 0.4; }
.step-active { 
  background: linear-gradient(135deg, #cda45e 0%, #e5b66a 100%);
  color: white;
}
.step-complete { 
  background: #10b981;
  color: white;
}
#location-map { height: 250px; border-radius: 12px; }
.payment-option:has(input:checked) {
  border-color: #cda45e;
  background: #fef9f3;
}
@keyframes slideIn {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}
.animate-slide { animation: slideIn 0.3s ease-out; }
</style>
</head>

<body class="bg-gray-50">

<!-- HEADER -->
<header class="sticky top-0 z-50 bg-white shadow-md">
  <nav class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img src="assets/images/logo1.png" alt="Logo" class="w-10 h-10 rounded-full" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22%3E%3Ccircle cx=%2220%22 cy=%2220%22 r=%2220%22 fill=%22%23cda45e%22/%3E%3Ctext x=%2220%22 y=%2228%22 font-size=%2220%22 fill=%22white%22 text-anchor=%22middle%22%3EK%3C/text%3E%3C/svg%3E'">
      <h1 class="text-xl font-bold text-gray-800">Kusina ni Katya</h1>
    </div>
    <a href="index.html" class="text-accent hover:text-accent-dark font-medium">‚Üê Back</a>
  </nav>
</header>

<!-- MAIN -->
<section class="py-8 px-4">
  <div class="max-w-6xl mx-auto">
    
    <!-- Progress Steps -->
    <div class="mb-8 bg-white rounded-2xl p-6 shadow-sm">
      <div class="flex items-center justify-between max-w-2xl mx-auto">
        <div class="flex flex-col items-center flex-1">
          <div id="step-1-indicator" class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg step-active mb-2 transition-all">1</div>
          <span class="text-sm font-medium text-gray-600">Cart</span>
        </div>
        <div class="h-1 flex-1 bg-gray-200 mx-2"></div>
        <div class="flex flex-col items-center flex-1">
          <div id="step-2-indicator" class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg bg-gray-200 mb-2 transition-all">2</div>
          <span class="text-sm font-medium text-gray-600">Details</span>
        </div>
        <div class="h-1 flex-1 bg-gray-200 mx-2"></div>
        <div class="flex flex-col items-center flex-1">
          <div id="step-3-indicator" class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg bg-gray-200 mb-2 transition-all">3</div>
          <span class="text-sm font-medium text-gray-600">Payment</span>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- Main Content Area -->
      <div class="lg:col-span-2">
        
        <!-- STEP 1: Cart Review -->
        <div id="step-1" class="bg-white rounded-2xl p-6 shadow-sm animate-slide">
          <h2 class="text-2xl font-bold mb-6">Your Cart</h2>
          <div id="cart-items" class="space-y-3"></div>
          <div id="empty-cart" class="hidden text-center py-12">
            <p class="text-gray-400 mb-4">Cart is empty</p>
            <a href="menu.html" class="text-accent font-medium">Browse Menu ‚Üí</a>
          </div>
          <button onclick="goToStep(2)" class="mt-6 w-full bg-gradient-to-r from-accent to-accent-dark text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all">
            Continue to Details ‚Üí
          </button>
        </div>

        <!-- STEP 2: Customer & Delivery Info -->
        <div id="step-2" class="hidden bg-white rounded-2xl p-6 shadow-sm animate-slide">
          <h2 class="text-2xl font-bold mb-6">Delivery & Contact</h2>
          
          <!-- Delivery Option -->
          <div class="mb-6">
            <label class="block font-semibold mb-3">Delivery Option</label>
            <div class="grid grid-cols-2 gap-3">
              <label class="payment-option border-2 rounded-xl p-4 cursor-pointer transition-all">
                <input type="radio" name="delivery-option" value="delivery" checked onchange="toggleDeliveryFields()" class="hidden">
                <div class="text-center">
                  <div class="text-3xl mb-2">üöö</div>
                  <div class="font-semibold">Delivery</div>
                  <div class="text-sm text-gray-500">‚Ç±30 fee</div>
                </div>
              </label>
              <label class="payment-option border-2 rounded-xl p-4 cursor-pointer transition-all">
                <input type="radio" name="delivery-option" value="pickup" onchange="toggleDeliveryFields()" class="hidden">
                <div class="text-center">
                  <div class="text-3xl mb-2">üè™</div>
                  <div class="font-semibold">Pickup</div>
                  <div class="text-sm text-gray-500">Free</div>
                </div>
              </label>
            </div>
          </div>

          <!-- Delivery Address -->
          <div id="delivery-address-section" class="mb-6">
            <label class="block font-semibold mb-2">Delivery Address</label>
            <textarea id="delivery-address" rows="2" placeholder="Enter your address" class="w-full px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none"></textarea>
            <button onclick="getCurrentLocation()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
              üìç Use Current Location
            </button>
            <div id="location-map-container" class="hidden mt-3">
              <div id="location-map"></div>
            </div>
          </div>

          <!-- Contact Info (Compact Grid) -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
              <label class="block font-semibold mb-2">Name</label>
              <input type="text" id="customer-name" placeholder="Juan Dela Cruz" class="w-full px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none">
            </div>
            <div>
              <label class="block font-semibold mb-2">Phone</label>
              <input type="tel" id="customer-phone" placeholder="+63 912 345 6789" class="w-full px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none">
            </div>
          </div>

          <div class="mb-6">
            <label class="block font-semibold mb-2">Email</label>
            <input type="email" id="customer-email" placeholder="juan@example.com" class="w-full px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none">
          </div>

          <div class="flex gap-3">
            <button onclick="goToStep(1)" class="flex-1 border-2 border-gray-300 py-3 rounded-xl font-semibold hover:bg-gray-50 transition-all">
              ‚Üê Back
            </button>
            <button onclick="goToStep(3)" class="flex-1 bg-gradient-to-r from-accent to-accent-dark text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all">
              Continue to Payment ‚Üí
            </button>
          </div>
        </div>

        <!-- STEP 3: Payment -->
        <div id="step-3" class="hidden bg-white rounded-2xl p-6 shadow-sm animate-slide">
          <h2 class="text-2xl font-bold mb-6">Payment Method</h2>
          
          <!-- Payment Options -->
          <div class="grid grid-cols-2 gap-3 mb-6">
            <label class="payment-option border-2 rounded-xl p-4 cursor-pointer transition-all">
              <input type="radio" name="payment-method" value="card" checked onchange="togglePaymentForm()" class="hidden">
              <div class="text-center">
                <div class="text-3xl mb-2">üí≥</div>
                <div class="font-semibold">Card</div>
                <div class="text-xs text-gray-500">Visa, Mastercard</div>
              </div>
            </label>
            <label class="payment-option border-2 rounded-xl p-4 cursor-pointer transition-all">
              <input type="radio" name="payment-method" value="gcash" onchange="togglePaymentForm()" class="hidden">
              <div class="text-center">
                <div class="mb-2 flex justify-center">
                  <img src="assets/images/gcashlogo.png" alt="GCash" class="h-10 w-auto object-contain">
                </div>
                <div class="font-semibold text-sm">GCash</div>
                <div class="text-xs text-gray-500">E-wallet</div>
              </div>
            </label>
          </div>

          <!-- Card Form -->
          <div id="card-payment-form" class="space-y-4 mb-6">
            <input type="text" id="card-number" placeholder="Card Number" maxlength="19" class="w-full px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none" oninput="formatCardNumber(this)">
            <div class="grid grid-cols-2 gap-3">
              <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5" class="px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none" oninput="formatExpiry(this)">
              <input type="text" id="card-cvc" placeholder="CVC" maxlength="3" class="px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
            <input type="text" id="card-name" placeholder="Cardholder Name" class="w-full px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none uppercase">
            <p class="text-xs text-gray-500">Test: 4343 4343 4343 4345</p>
          </div>

          <!-- GCash Info -->
          <div id="gcash-payment-info" class="hidden mb-6 p-4 bg-blue-50 rounded-xl border-2 border-blue-200">
            <div class="flex items-start gap-3">
              <img src="https://logos-world.net/wp-content/uploads/2022/03/GCash-Symbol.png" alt="GCash" class="w-12 h-12 object-contain flex-shrink-0">
              <div>
                <h4 class="font-semibold text-dark mb-2">GCash Payment</h4>
                <p class="text-sm text-gray-700">You will be redirected to GCash to complete your payment securely.</p>
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button onclick="goToStep(2)" class="flex-1 border-2 border-gray-300 py-3 rounded-xl font-semibold hover:bg-gray-50 transition-all">
              ‚Üê Back
            </button>
            <button onclick="initiateCheckout()" id="checkout-btn" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all">
              Complete Order ‚úì
            </button>
          </div>
        </div>
      </div>

      <!-- Order Summary Sidebar -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-2xl p-6 shadow-sm sticky top-24">
          <h3 class="text-xl font-bold mb-4">Order Summary</h3>
          
          <!-- Voucher -->
          <div class="mb-4">
            <div class="flex gap-2">
              <input type="text" id="voucher-input" placeholder="Voucher code" class="flex-1 px-3 py-2 border-2 rounded-lg text-sm uppercase focus:border-accent focus:outline-none">
              <button onclick="applyVoucher()" class="px-4 py-2 bg-accent text-white rounded-lg text-sm font-semibold hover:bg-accent-dark">Apply</button>
            </div>
            <div id="applied-voucher-display" class="hidden mt-2 p-2 bg-green-50 rounded-lg text-sm">
              <div class="flex justify-between items-center">
                <span id="voucher-code" class="text-green-700 font-semibold"></span>
                <button onclick="removeVoucher()" class="text-red-500 text-xs">Remove</button>
              </div>
            </div>
          </div>

          <!-- Price Breakdown -->
          <div class="space-y-2 py-4 border-t border-b">
            <div class="flex justify-between text-sm">
              <span>Subtotal</span>
              <span id="subtotal">‚Ç±0.00</span>
            </div>
            <div id="voucher-discount-row" class="hidden flex justify-between text-sm text-green-600">
              <span>Discount</span>
              <span id="voucher-discount">-‚Ç±0.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span>Delivery</span>
              <span id="delivery-fee">‚Ç±30.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span>Tax</span>
              <span id="tax">‚Ç±0.00</span>
            </div>
          </div>

          <div class="flex justify-between text-xl font-bold mt-4">
            <span>Total</span>
            <span id="total" class="text-accent">‚Ç±0.00</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
const DELIVERY_FEE = 30;
const TAX_RATE = 0.12;
const API_URL = 'http://localhost:3000/api';
let cart = [];
let appliedVoucher = null;
let userLocation = null;
let locationMap = null;
let locationMarker = null;
let currentStep = 1;

function getAuthToken() {
  return sessionStorage.getItem('authToken');
}

function markVoucherAsUsed(voucherCode) {
  if (!voucherCode) return;
  
  const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
  if (!currentUser) return;
  
  const usedVouchersKey = `usedVouchers_${currentUser.email}`;
  const usedVouchers = JSON.parse(localStorage.getItem(usedVouchersKey) || '[]');
  
  if (!usedVouchers.includes(voucherCode)) {
    usedVouchers.push(voucherCode);
    localStorage.setItem(usedVouchersKey, JSON.stringify(usedVouchers));
    console.log(`‚úÖ Voucher ${voucherCode} marked as used for ${currentUser.email}`);
  }
}

function loadCartFromStorage() {
  const saved = localStorage.getItem('kusinaCart');
  cart = saved ? JSON.parse(saved) : [];
}

function goToStep(step) {
  if (step === 2 && cart.length === 0) {
    alert('Your cart is empty!');
    return;
  }
  
  if (step === 3) {
    if (!validateStep2()) return;
  }
  
  document.getElementById(`step-${currentStep}`).classList.add('hidden');
  document.getElementById(`step-${step}`).classList.remove('hidden');
  
  for (let i = 1; i <= 3; i++) {
    const indicator = document.getElementById(`step-${i}-indicator`);
    if (i < step) {
      indicator.className = 'w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg step-complete mb-2 transition-all';
      indicator.innerHTML = '‚úì';
    } else if (i === step) {
      indicator.className = 'w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg step-active mb-2 transition-all';
      indicator.innerHTML = i;
    } else {
      indicator.className = 'w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg bg-gray-200 mb-2 transition-all';
      indicator.innerHTML = i;
    }
  }
  
  currentStep = step;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function validateStep2() {
  const name = document.getElementById('customer-name').value.trim();
  const email = document.getElementById('customer-email').value.trim();
  const phone = document.getElementById('customer-phone').value.trim();
  const deliveryOption = document.querySelector('input[name="delivery-option"]:checked').value;
  
  if (!name || !email || !phone) {
    alert('Please fill in all contact information');
    return false;
  }
  
  if (deliveryOption === 'delivery') {
    const address = document.getElementById('delivery-address').value.trim();
    if (!address) {
      alert('Please enter delivery address');
      return false;
    }
  }
  
  return true;
}

function toggleDeliveryFields() {
  const deliveryOption = document.querySelector('input[name="delivery-option"]:checked').value;
  const addressSection = document.getElementById('delivery-address-section');
  
  if (deliveryOption === 'delivery') {
    addressSection.classList.remove('hidden');
  } else {
    addressSection.classList.add('hidden');
  }
  
  updateTotals();
}

function getCurrentLocation() {
  if (!navigator.geolocation) {
    alert('Geolocation not supported');
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (position) => {
      userLocation = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      displayLocationOnMap(userLocation);
      reverseGeocode(userLocation);
    },
    (error) => {
      alert('Unable to get location');
    }
  );
}

function displayLocationOnMap(location) {
  const mapContainer = document.getElementById('location-map-container');
  mapContainer.classList.remove('hidden');
  
  if (!locationMap) {
    locationMap = L.map('location-map').setView([location.lat, location.lng], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap',
      maxZoom: 19
    }).addTo(locationMap);
  } else {
    locationMap.setView([location.lat, location.lng], 15);
  }
  
  if (locationMarker) {
    locationMarker.setLatLng([location.lat, location.lng]);
  } else {
    locationMarker = L.marker([location.lat, location.lng]).addTo(locationMap);
  }
}

async function reverseGeocode(location) {
  try {
    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${location.lat}&lon=${location.lng}&format=json`);
    const data = await response.json();
    if (data && data.display_name) {
      document.getElementById('delivery-address').value = data.display_name;
    }
  } catch (error) {
    console.error('Geocoding error:', error);
  }
}

function displayCart() {
  const cartItemsContainer = document.getElementById('cart-items');
  const emptyCartDiv = document.getElementById('empty-cart');
  
  loadCartFromStorage();
  
  if (!cart || cart.length === 0) {
    cartItemsContainer.innerHTML = '';
    emptyCartDiv.classList.remove('hidden');
    return;
  }
  
  emptyCartDiv.classList.add('hidden');
  
  cartItemsContainer.innerHTML = cart.map((item, index) => `
    <div class="flex gap-3 p-3 bg-gray-50 rounded-xl">
      <div class="w-16 h-16 bg-gradient-to-br from-accent to-amber-600 rounded-lg flex items-center justify-center text-2xl flex-shrink-0">
        ${item.image ? `<img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover rounded-lg">` : 'üç≤'}
      </div>
      <div class="flex-1 min-w-0">
        <h4 class="font-semibold text-sm mb-1">${item.name}</h4>
        <p class="text-xs text-gray-500">‚Ç±${item.price.toFixed(2)}</p>
        <div class="flex items-center gap-2 mt-2">
          <button onclick="updateQuantity(${index}, -1)" class="w-6 h-6 bg-gray-200 rounded-full text-sm font-bold hover:bg-accent hover:text-white">‚àí</button>
          <span class="text-sm font-semibold w-6 text-center">${item.quantity}</span>
          <button onclick="updateQuantity(${index}, 1)" class="w-6 h-6 bg-gray-200 rounded-full text-sm font-bold hover:bg-accent hover:text-white">+</button>
        </div>
      </div>
      <div class="text-right">
        <p class="font-bold text-accent">‚Ç±${(item.price * item.quantity).toFixed(2)}</p>
        <button onclick="removeItem(${index})" class="text-xs text-red-500 hover:underline mt-1">Remove</button>
      </div>
    </div>
  `).join('');
  
  updateTotals();
}

function updateQuantity(index, change) {
  if (cart[index]) {
    cart[index].quantity += change;
    if (cart[index].quantity <= 0) {
      cart.splice(index, 1);
    }
    localStorage.setItem('kusinaCart', JSON.stringify(cart));
    displayCart();
  }
}

function removeItem(index) {
  cart.splice(index, 1);
  localStorage.setItem('kusinaCart', JSON.stringify(cart));
  displayCart();
}

function updateTotals() {
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const deliveryOption = document.querySelector('input[name="delivery-option"]:checked')?.value || 'delivery';
  const delivery = deliveryOption === 'delivery' ? DELIVERY_FEE : 0;
  
  const voucherDiscount = calculateVoucherDiscount(subtotal, delivery);
  const discountedSubtotal = subtotal - (appliedVoucher && appliedVoucher.type !== 'shipping' ? voucherDiscount : 0);
  const finalDelivery = appliedVoucher && appliedVoucher.type === 'shipping' ? 0 : delivery;
  
  const tax = discountedSubtotal * TAX_RATE;
  const total = discountedSubtotal + finalDelivery + tax;
  
  document.getElementById('subtotal').textContent = `‚Ç±${subtotal.toFixed(2)}`;
  document.getElementById('delivery-fee').textContent = `‚Ç±${finalDelivery.toFixed(2)}`;
  document.getElementById('tax').textContent = `‚Ç±${tax.toFixed(2)}`;
  document.getElementById('total').textContent = `‚Ç±${total.toFixed(2)}`;
  
  if (appliedVoucher) {
    document.getElementById('voucher-discount').textContent = `-‚Ç±${voucherDiscount.toFixed(2)}`;
  }
}

function calculateVoucherDiscount(subtotal, deliveryFee) {
  if (!appliedVoucher) return 0;
  
  switch (appliedVoucher.type) {
    case 'percentage':
      return subtotal * (appliedVoucher.value / 100);
    case 'fixed':
      return appliedVoucher.value;
    case 'shipping':
      return deliveryFee;
    default:
      return 0;
  }
}

function applyVoucher() {
  const voucherCode = document.getElementById('voucher-input').value.trim().toUpperCase();
  
  if (!voucherCode) {
    alert('Please enter voucher code');
    return;
  }
  
  const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
  if (!currentUser) {
    alert('Please login to use vouchers');
    window.location.href = 'login.html';
    return;
  }
  
  const usedVouchersKey = `usedVouchers_${currentUser.email}`;
  const usedVouchers = JSON.parse(localStorage.getItem(usedVouchersKey) || '[]');
  
  if (usedVouchers.includes(voucherCode)) {
    alert('This voucher has already been used!');
    document.getElementById('voucher-input').value = '';
    return;
  }
  
  const savedVouchers = localStorage.getItem('kusinaVouchers');
  const vouchers = savedVouchers ? JSON.parse(savedVouchers) : [];
  const voucher = vouchers.find(v => v.id === voucherCode);
  
  if (!voucher) {
    alert('Invalid voucher code!');
    return;
  }
  
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  if (subtotal < voucher.minSpend) {
    alert(`Minimum spend of ‚Ç±${voucher.minSpend} required`);
    return;
  }
  
  appliedVoucher = voucher;
  document.getElementById('applied-voucher-display').classList.remove('hidden');
  document.getElementById('voucher-code').textContent = voucher.id;
  document.getElementById('voucher-discount-row').classList.remove('hidden');
  updateTotals();
  alert('Voucher applied! üéâ');
}

function removeVoucher() {
  appliedVoucher = null;
  document.getElementById('voucher-input').value = '';
  document.getElementById('applied-voucher-display').classList.add('hidden');
  document.getElementById('voucher-discount-row').classList.add('hidden');
  updateTotals();
}

function togglePaymentForm() {
  const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
  const cardForm = document.getElementById('card-payment-form');
  const gcashInfo = document.getElementById('gcash-payment-info');
  
  if (paymentMethod === 'card') {
    cardForm.classList.remove('hidden');
    gcashInfo.classList.add('hidden');
  } else {
    cardForm.classList.add('hidden');
    gcashInfo.classList.remove('hidden');
  }
}

function formatCardNumber(input) {
  let value = input.value.replace(/\s/g, '');
  let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
  input.value = formattedValue;
}

function formatExpiry(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length >= 2) {
    value = value.slice(0, 2) + '/' + value.slice(2, 4);
  }
  input.value = value;
}

async function initiateCheckout() {
  const token = getAuthToken();
  if (!token) {
    alert('Please login first');
    window.location.href = 'login.html';
    return;
  }
  
  if (cart.length === 0) {
    alert('Your cart is empty!');
    return;
  }
  
  const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
  const btn = document.getElementById('checkout-btn');
  
  btn.disabled = true;
  btn.innerHTML = 'Processing...';
  
  try {
    if (paymentMethod === 'card') {
      await processCardPayment(token);
    } else {
      await processGCashPayment(token);
    }
  } catch (error) {
    console.error('Checkout error:', error);
    alert('Error: ' + error.message);
    btn.disabled = false;
    btn.innerHTML = 'Complete Order ‚úì';
  }
}

async function processCardPayment(token) {
  console.log('üí≥ Processing card payment...');
  
  const name = document.getElementById('customer-name').value.trim();
  const email = document.getElementById('customer-email').value.trim();
  const phone = document.getElementById('customer-phone').value.trim();
  const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
  const cardExpiry = document.getElementById('card-expiry').value;
  const cardCvc = document.getElementById('card-cvc').value;
  const deliveryOption = document.querySelector('input[name="delivery-option"]:checked').value;
  const deliveryAddress = deliveryOption === 'delivery' ? document.getElementById('delivery-address').value.trim() : 'Pickup';
  
  if (!cardNumber || !cardExpiry || !cardCvc) {
    throw new Error('Please fill in all card details');
  }
  
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const delivery = deliveryOption === 'delivery' ? DELIVERY_FEE : 0;
  const voucherDiscount = calculateVoucherDiscount(subtotal, delivery);
  const discountedSubtotal = subtotal - (appliedVoucher && appliedVoucher.type !== 'shipping' ? voucherDiscount : 0);
  const finalDelivery = appliedVoucher && appliedVoucher.type === 'shipping' ? 0 : delivery;
  const tax = discountedSubtotal * TAX_RATE;
  const total = discountedSubtotal + finalDelivery + tax;
  const amountInCentavos = Math.round(total * 100);

  try {
    const intentResponse = await fetch(`${API_URL}/create-payment-intent`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        amount: amountInCentavos,
        currency: 'PHP',
        customer: { name, email },
        card: {
          number: cardNumber,
          exp_month: parseInt(cardExpiry.split('/')[0]),
          exp_year: parseInt('20' + cardExpiry.split('/')[1]),
          cvc: cardCvc
        }
      })
    });

    if (!intentResponse.ok) {
      const error = await intentResponse.json();
      throw new Error(error.message || 'Payment failed');
    }

    const intentData = await intentResponse.json();

    const orderData = {
      customer_name: name,
      customer_email: email,
      customer_phone: phone,
      delivery_address: deliveryAddress,
      delivery_coordinates: userLocation ? `${userLocation.lat},${userLocation.lng}` : null,
      items: cart,
      subtotal: subtotal,
      delivery_fee: finalDelivery,
      tax: tax,
      total: total,
      delivery_option: deliveryOption,
      payment_method: 'card',
      payment_status: 'paid',
      payment_intent_id: intentData.paymentIntentId,
      voucher_code: appliedVoucher ? appliedVoucher.id : null,
      voucher_discount: voucherDiscount
    };

    const orderResponse = await fetch(`${API_URL}/create-order`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(orderData)
    });

    if (!orderResponse.ok) {
      const error = await orderResponse.json();
      throw new Error(error.message || 'Failed to create order');
    }

    const result = await orderResponse.json();
    
    if (appliedVoucher) {
      markVoucherAsUsed(appliedVoucher.id);
    }
    
    showSuccessModal(result.order_id);
    cart = [];
    localStorage.removeItem('kusinaCart');
    localStorage.removeItem('selectedVoucher');
    
    setTimeout(() => {
      window.location.href = 'orders.html';
    }, 3000);
  } catch (error) {
    console.error('‚ùå Card payment error:', error);
    throw error;
  }
}

async function processGCashPayment(token) {
  console.log('üì± Processing GCash payment...');
  
  const name = document.getElementById('customer-name').value.trim();
  const email = document.getElementById('customer-email').value.trim();
  const phone = document.getElementById('customer-phone').value.trim();
  const deliveryOption = document.querySelector('input[name="delivery-option"]:checked').value;
  const deliveryAddress = deliveryOption === 'delivery' ? document.getElementById('delivery-address').value.trim() : 'Pickup';
  
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const delivery = deliveryOption === 'delivery' ? DELIVERY_FEE : 0;
  const voucherDiscount = calculateVoucherDiscount(subtotal, delivery);
  const discountedSubtotal = subtotal - (appliedVoucher && appliedVoucher.type !== 'shipping' ? voucherDiscount : 0);
  const finalDelivery = appliedVoucher && appliedVoucher.type === 'shipping' ? 0 : delivery;
  const tax = discountedSubtotal * TAX_RATE;
  const total = discountedSubtotal + finalDelivery + tax;
  const amountInCentavos = Math.round(total * 100);

  try {
    const sourceResponse = await fetch(`${API_URL}/paymongo/create-gcash-payment`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        amount: amountInCentavos,
        currency: 'PHP',
        customer: { name, email }
      })
    });

    if (!sourceResponse.ok) {
      const error = await sourceResponse.json();
      throw new Error(error.message || 'Failed to create GCash payment');
    }

    const sourceData = await sourceResponse.json();

    const orderData = {
      customer_name: name,
      customer_email: email,
      customer_phone: phone,
      delivery_address: deliveryAddress,
      delivery_coordinates: userLocation ? `${userLocation.lat},${userLocation.lng}` : null,
      items: cart,
      subtotal: subtotal,
      delivery_fee: finalDelivery,
      tax: tax,
      total: total,
      delivery_option: deliveryOption,
      payment_method: 'gcash',
      payment_status: 'pending',
      payment_source_id: sourceData.source_id,
      voucher_code: appliedVoucher ? appliedVoucher.id : null,
      voucher_discount: voucherDiscount
    };

    const orderResponse = await fetch(`${API_URL}/create-order`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(orderData)
    });

    const result = await orderResponse.json();
    
    if (!orderResponse.ok || !result.success) {
      throw new Error(result.message || 'Failed to create order');
    }
    
    if (appliedVoucher) {
      markVoucherAsUsed(appliedVoucher.id);
    }
    
    cart = [];
    localStorage.removeItem('kusinaCart');
    localStorage.removeItem('selectedVoucher');
    
    window.location.href = sourceData.checkout_url;
    
  } catch (error) {
    console.error('‚ùå GCash payment error:', error);
    alert('GCash payment failed: ' + error.message);
    throw error;
  }
}

function showSuccessModal(orderId) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm';
  modal.innerHTML = `
    <div class="bg-white rounded-3xl p-8 max-w-md mx-4 shadow-2xl text-center">
      <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-dark mb-2">Order Successful!</h2>
      <p class="text-gray-600 mb-6">Your order has been placed successfully.</p>
      <div class="bg-gray-50 rounded-lg p-4 mb-6">
        <p class="text-sm text-gray-500">Order ID</p>
        <p class="text-lg font-bold text-accent font-mono">${orderId}</p>
      </div>
      ${appliedVoucher ? `<p class="text-sm text-green-600 mb-4">‚úì Voucher ${appliedVoucher.id} applied!</p>` : ''}
      <p class="text-sm text-gray-500 mb-4">Redirecting to track your order...</p>
      <a href="orders.html" class="inline-block px-8 py-3 bg-gradient-to-r from-accent to-accent-dark text-white font-semibold rounded-full hover:shadow-lg transition-all">
        Track My Order
      </a>
    </div>
  `;
  document.body.appendChild(modal);
}

function loadSelectedVoucher() {
  const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
  if (!currentUser) {
    localStorage.removeItem('selectedVoucher');
    return;
  }
  
  const selectedVoucher = localStorage.getItem('selectedVoucher');
  if (selectedVoucher) {
    appliedVoucher = JSON.parse(selectedVoucher);
    
    const usedVouchersKey = `usedVouchers_${currentUser.email}`;
    const usedVouchers = JSON.parse(localStorage.getItem(usedVouchersKey) || '[]');
    
    if (usedVouchers.includes(appliedVoucher.id)) {
      alert('This voucher has already been used and cannot be applied again.');
      appliedVoucher = null;
      localStorage.removeItem('selectedVoucher');
      return;
    }
    
    document.getElementById('voucher-input').value = appliedVoucher.id;
    localStorage.removeItem('selectedVoucher');
    document.getElementById('applied-voucher-display').classList.remove('hidden');
    document.getElementById('voucher-code').textContent = appliedVoucher.id;
    document.getElementById('voucher-discount-row').classList.remove('hidden');
    updateTotals();
  }
}

function loadUserInfo() {
  const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
  
  if (currentUser) {
    if (currentUser.name) document.getElementById('customer-name').value = currentUser.name;
    if (currentUser.email) document.getElementById('customer-email').value = currentUser.email;
    if (currentUser.phone) document.getElementById('customer-phone').value = currentUser.phone;
  }
}

window.addEventListener('DOMContentLoaded', () => {
  loadCartFromStorage();
  loadSelectedVoucher();
  loadUserInfo();
  displayCart();
  toggleDeliveryFields();
});
</script>

</body>
</html>